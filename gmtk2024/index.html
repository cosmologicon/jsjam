<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<title>GMTK 2024 game</title>
<script src="UFX.js"></script>
<script src="view.js"></script>
<script src="grid.js"></script>
<script src="robot.js"></script>
<script src="control.js"></script>
<script src="quest.js"></script>
<script src="hud.js"></script>
<canvas id=canvas></canvas>
<style>
canvas { background: black }
</style>
<script>
"use strict"
let tau = 2 * Math.PI
let canvas = document.getElementById("canvas")
canvas.width = 1600
canvas.height = 900
let context = canvas.getContext("2d")
UFX.maximize.fill(canvas, "aspect")
UFX.draw.setcontext(context)
UFX.audio.init()
UFX.audio.makegainnode({ name: "main", gain: 0, })
UFX.audio.makegainnode({ name: "sfx", output: "main" })
UFX.audio.makegainnode({ name: "music", output: "main", gain: 0.3 })
UFX.audio.loadbuffers({
	select: "sound/select.ogg",
	no: "sound/no.ogg",
	build: "sound/build.ogg",
	break: "sound/break.ogg",
	fix1: "sound/fix1.ogg",
	fix2: "sound/fix2.ogg",
	fix3: "sound/fix3.ogg",
	fix4: "sound/fix4.ogg",
	
	gettingitdone: "sound/gettingitdone.ogg",
})
function playsound(sname) {
	UFX.audio.playbuffer(sname, { output: "sfx", gain: 1, })
}
UFX.key.init()
UFX.key.remaparrows(true)
UFX.resource.loadwebfonts("Viga", "Roboto Mono", "Days One")
UFX.resource.onload = () => {
	UFX.scene.push("play")
	UFX.scene.init({ minups: 10, maxups: 120 })
	UFX.audio.playbuffer("gettingitdone",
		{ name: "gettingitdone", output: "music", loop: true, gain: 1 })
}
UFX.resource.onloading = () => {}
UFX.scenes.play = {
	pos: [-10000, -10000],
	robotxVmove: null,
	think: function (dt) {
		let pointer = UFX.pointer(canvas)
		let kstate = UFX.key.state()
		control.update(pointer, kstate)
		for (let node of root.allnodes()) node.think(dt)
		quest.think(dt)
		grid.think(dt)
		view.think(dt)
		hud.think(dt)
	},
	draw: function () {
		UFX.draw("fs #864 f0")
		UFX.draw("[ z", canvas.width / 1600, canvas.height / 900)
		UFX.draw("[ t 600 200 font 100px~'Viga' r -0.1",
			"tab center middle fs black ss gray lw 1 fst0 GMTK~Jam~2024~game ]")
		view.scale()
//		UFX.draw("[ t", control.tile, "alpha 0.1 fs white fr -0.5 -0.5 1 1 ]")
		grid.draw()
		robot.draw()
		if (control.xroll !== null) {
			drawarrow([control.xroll, 0], root.pos)
		}
		UFX.draw("]")  // view.scale
		if (control.grabbed) {
			let [dist, nearest] = nearesttile(control.grabbed.spots(), control.posG)
			UFX.draw("[ alpha 0.5 fs black fr 0 0 1600 900 ]")
			view.scale()
			for (let spot of control.grabbed.spots()) {
				if (poseq(spot, control.grabbed.pos)) continue
				let lit = poseq(spot, nearest)
				drawarrow(spot, control.grabbed.pos, lit)
			}
			UFX.draw("]")
		}
		hud.draw()		
		let texts = quest.text()
		if (texts.length > 0) {
			UFX.draw("font 40px~'Days~One' tab center middle ss black lw 2",
				"fs", UFX.draw.lingrad(0, -20, 0, 0, 0, "#eef", 1, "#aab"))
			texts.forEach((text, j) => {
				UFX.draw("[ t", 800, 900 - 50 * (texts.length - j))
				context.strokeText(text, 0, 0)
				UFX.draw("sh black 2 2 3")
				context.fillText(text, 0, 0)
				UFX.draw("]")
			})
		}
		texts = quest.controls()
		if (texts.length > 0) {
			UFX.draw("font 24px~'Days~One' tab right top ss black lw 1",
				"fs #ccf")
			texts.forEach((text, j) => {
				UFX.draw("[ t", 1590, 10 + 26 * j)
				context.strokeText(text, 0, 0)
				context.fillText(text, 0, 0)
				UFX.draw("]")
			})
		}
		UFX.draw("]")
		canvas.style.cursor = control.cursor()
	},
}
</script>

