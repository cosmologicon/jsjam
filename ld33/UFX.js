// UFX v0 by Christopher Night. CC0. github.com/cosmologicon/UFX
// Modules included: draw pause random texture mouse key maximize scene playback noise tracer Thing touch pointer resource ticker
// UFX.draw module: some convenience functions for invoking context methods
// The basic UFX.draw() function takes a string inspired by the SVG path string specification,
//   but with some important differences
// For a complete listing of UFX.draw tokens, please see the UFX documentation here:
// https://code.google.com/p/unifac/wiki/UFXDocumentation#UFX.draw_token_list
// Three ways to invoke the function here.
// UFX.draw(context, drawstring)
// UFX.draw.setcontext(context) ; UFX.draw(drawstring)
// UFX.draw.extend(context) ; context.draw(drawstring)
// The drawstring can also be a series of strings or values.
// UFX.draw(context, "( m 0 0 l", x, y, ") s")
"use strict";var UFX=UFX||{};UFX._draw=function(){function b(){for(var c=0;c<arguments.length;++c){var d=arguments[c];d.split?a.push.apply(a,d.split(" ")):d instanceof Array?b.apply(this,d):a.push(d)}}function d(a){if(typeof a!="string")return a;switch(a.substr(0,3)){case"lg~":return UFX._draw.lingrad.apply(c,a.substr(3).split("~"));case"rg~":return UFX._draw.radgrad.apply(c,a.substr(3).split("~"));default:return a}}var a=[];b.apply(this,arguments);var c=this;for(var e=0;e<a.length;++e)switch(a[e].toLowerCase()){case"b":case"(":case"beginpath":this.beginPath();break;case")":case"closepath":this.closePath();break;case"m":case"moveto":this.moveTo(+a[++e],+a[++e]);break;case"l":case"lineto":this.lineTo(+a[++e],+a[++e]);break;case"q":case"quadraticcurveto":this.quadraticCurveTo(+a[++e],+a[++e],+a[++e],+a[++e]);break;case"c":case"beziercurveto":this.bezierCurveTo(+a[++e],+a[++e],+a[++e],+a[++e],+a[++e],+a[++e]);break;case"a":case"arc":this.arc(+a[++e],+a[++e],+a[++e],+a[++e],+a[++e]);break;case"aa":case"antiarc":this.arc(+a[++e],+a[++e],+a[++e],+a[++e],+a[++e],!0);break;case"arcto":this.arcTo(+a[++e],+a[++e],+a[++e],+a[++e],+a[++e]);break;case"o":case"circle":this.arc(+a[++e],+a[++e],+a[++e],0,2*Math.PI);break;case"rr":case"roundedrect":var f=+a[++e],g=+a[++e],h=+a[++e],i=+a[++e],j=+a[++e];this.beginPath(),this.moveTo(f+j,g),this.arcTo(f+h,g,f+h,g+i,j),this.arcTo(f+h,g+i,f,g+i,j),this.arcTo(f,g+i,f,g,j),this.arcTo(f,g,f+h,g,j),this.closePath();break;case"t":case"translate":this.translate(+a[++e],+a[++e]);break;case"r":case"rotate":this.rotate(+a[++e]);break;case"z":case"scale":this.scale(+a[++e],+a[++e]);break;case"zx":case"xscale":this.scale(+a[++e],1);break;case"zy":case"yscale":this.scale(1,+a[++e]);break;case"hflip":this.scale(-1,1);break;case"vflip":this.scale(1,-1);break;case"x":case"transform":this.transform(+a[++e],+a[++e],+a[++e],+a[++e],+a[++e],+a[++e]);break;case"xshear":this.transform(1,0,+a[++e],1,0,0);break;case"yshear":this.transform(1,+a[++e],0,1,0,0);break;case"f":case"fill":this.fill();break;case"s":case"stroke":this.stroke();break;case"fr":case"fillrect":this.fillRect(+a[++e],+a[++e],+a[++e],+a[++e]);break;case"sr":case"strokerect":this.strokeRect(+a[++e],+a[++e],+a[++e],+a[++e]);break;case"fsr":case"fillstrokerect":var f=+a[++e],g=+a[++e],h=+a[++e],i=+a[++e];this.fillRect(f,g,h,i),this.strokeRect(f,g,h,i);break;case"sfr":case"strokefillrect":var f=+a[++e],g=+a[++e],h=+a[++e],i=+a[++e];this.strokeRect(f,g,h,i),this.fillRect(f,g,h,i);break;case"cr":case"clearrect":this.clearRect(+a[++e],+a[++e],+a[++e],+a[++e]);break;case"f0":case"fillall":this.fillRect(0,0,this.canvas.width,this.canvas.height);break;case"c0":case"clearall":this.clearRect(0,0,this.canvas.width,this.canvas.height);break;case"tr":case"tracerect":var f=+a[++e],g=+a[++e],h=+a[++e],i=+a[++e];this.beginPath(),this.moveTo(f,g),this.lineTo(f+h,g),this.lineTo(f+h,g+i),this.lineTo(f,g+i),this.closePath();break;case"fs":case"fillstyle":this.fillStyle=d(a[++e]);break;case"ss":case"strokestyle":this.strokeStyle=d(a[++e]);break;case"shadowblur":case"shb":this.shadowBlur=+a[++e];break;case"shadowcolor":case"shc":this.shadowColor=d(a[++e]);break;case"shadowoffsetx":case"shadowx":case"shx":this.shadowOffsetX=+a[++e];break;case"shadowoffsety":case"shadowy":case"shy":this.shadowOffsetY=+a[++e];break;case"shadowoffsetxy":case"shadowxy":case"shxy":this.shadowOffsetX=+a[++e],this.shadowOffsetY=+a[++e];break;case"shadow":case"sh":this.shadowColor=d(a[++e]),this.shadowOffsetX=+a[++e],this.shadowOffsetY=+a[++e],this.shadowBlur=+a[++e];break;case"drawimage":this.drawImage(a[++e],+a[++e],+a[++e]);break;case"drawimage0":this.drawImage(a[++e],0,0);break;case"clip":this.clip();break;case"al":case"alpha":case"globalalpha":this.globalAlpha=+a[++e];break;case"lw":case"linewidth":this.lineWidth=+a[++e];break;case"lc":case"linecap":this.lineCap=a[++e];break;case"textalign":case"ta":this.textAlign=a[++e];break;case"textbaseline":case"tb":this.textBaseline=a[++e];break;case"textalignbaseline":case"tab":this.textAlign=a[++e],this.textBaseline=a[++e];break;case"[":case"save":this.save();break;case"]":case"restore":this.restore();break;case"font":this.font=a[++e].replace(/~/g," ");break;case"filltext":case"ft":this.fillText(a[++e].replace(/~/g," "),+a[++e],+a[++e]);break;case"filltext0":case"ft0":this.fillText(a[++e].replace(/~/g," "),0,0);break;case"stroketext":case"st":this.strokeText(a[++e].replace(/~/g," "),+a[++e],+a[++e]);break;case"stroketext0":case"st0":this.strokeText(a[++e].replace(/~/g," "),0,0);break;case"fillstroketext":case"fst":var k=a[++e].replace(/~/g," "),f=+a[++e],g=+a[++e];this.fillText(k,f,g),this.strokeText(k,f,g);break;case"fillstroketext0":case"fst0":var k=a[++e].replace(/~/g," ");this.fillText(k,0,0),this.strokeText(k,0,0);break;case"strokefilltext":case"sft":var k=a[++e].replace(/~/g," "),f=+a[++e],g=+a[++e];this.strokeText(k,f,g),this.fillText(k,f,g);break;case"strokefilltext0":case"sft0":var k=a[++e].replace(/~/g," ");this.strokeText(k,0,0),this.fillText(k,0,0);break;default:throw"Unrecognized draw token "+a[e]}},UFX._draw.circle=function(a,b,c,d,e,f){this.save(),this.beginPath(),this.arc(a,b,c,0,2*Math.PI),d&&(this.fillStyle=d,this.fill());if(e||f)e&&(this.strokeStyle=e),f&&(this.lineWidth=f),this.stroke();this.restore()},UFX._draw.lingrad=function(a,b,c,d){var e=this.createLinearGradient(+a,+b,+c,+d);for(var f=4;f<arguments.length;f+=2)e.addColorStop(+arguments[f],arguments[f+1]);return e},UFX._draw.radgrad=function(a,b,c,d,e,f){var g=this.createRadialGradient(+a,+b,+c,+d,+e,+f);for(var h=6;h<arguments.length;h+=2)g.addColorStop(+arguments[h],arguments[h+1]);return g},UFX.draw=function(a){if(a.beginPath)return UFX._draw.apply(a,Array.prototype.slice.call(arguments,1));if(UFX.draw._context)return UFX._draw.apply(UFX.draw._context,arguments);throw"UFX.draw must be called with context as first argument"};for(var mname in UFX._draw)UFX.draw[mname]=function(a,b){return function(b){return b.beginPath?a.apply(b,Array.prototype.slice.call(arguments,1)):(UFX.draw._context||(UFX.draw._context=document.createElement("canvas").getContext("2d")),a.apply(UFX.draw._context,arguments))}}(UFX._draw[mname],mname);UFX.draw.setcontext=function(a){UFX.draw._context=a},UFX.draw.extend=function(a){a.draw=function(){UFX._draw.apply(a,arguments)};for(var b in UFX._draw)a.draw[b]=function(b){return function(){return b.apply(a,arguments)}}(UFX._draw[b])},"use strict",UFX.pause=function(){UFX.pause.ispaused()||UFX.scene.push(UFX.pause.Pause)},UFX.pause.unpause=function(){UFX.pause.ispaused()&&UFX.scene.pop()},UFX.pause.ispaused=function(){return UFX.scene.top()===UFX.pause.Pause},UFX.pause.init=function(){document.addEventListener("blur",UFX.pause,!1)},UFX.pause.Pause={},UFX.pause.Pause.start=function(){var a=context.canvas;this.x=a.width,this.y=a.height,this.backdrop=document.createElement("canvas"),this.backdrop.width=this.x,this.backdrop.height=this.y,this.bcontext=this.backdrop.getContext("2d"),this.bcontext.drawImage(a,0,0),this.bcontext.fillStyle="rgba(64,64,64,0.7)",this.bcontext.fillRect(0,0,this.x,this.y),this.t=0,this.r=Math.min(this.x,this.y)*.3,UFX.mouse.clearevents()},UFX.pause.Pause.thinkargs=function(a){var b=!1;return UFX.mouse.events().forEach(function(a){a.type=="up"&&(b=!0)}),UFX.key&&(UFX.key.clearevents(),UFX.key.clearcombos()),[a,b]},UFX.pause.Pause.think=function(a,b){context.drawImage(this.backdrop,0,0),this.t+=a,context.save(),context.translate(.5*this.x,.5*this.y);if(this.t<.25){var c=30*this.t,d=1-4*this.t;context.scale(1+d*Math.cos(c),1-d*Math.sin(c))}context.scale(this.r,this.r),context.fillStyle="rgba(255,255,255,0.5)",context.beginPath(),context.moveTo(.8,0),context.lineTo(-0.5,-0.7),context.lineTo(-0.5,.7),context.closePath(),context.fill(),context.restore(),b&&UFX.pause.unpause()},"use strict";var UFX=UFX||{};UFX.random=function(a,b){return typeof b=="undefined"&&(b=a,a=0,typeof b=="undefined"&&(b=1)),UFX.random.rand()*(b-a)/4294967296+a},UFX.random.rand=function(a,b){return typeof b!="undefined"?a+UFX.random.rand(b-a):(typeof UFX.random.seed=="undefined"&&UFX.random.setseed(),UFX.random.seed=(1664525*UFX.random.seed+1013904223)%4294967296,a?Math.floor(UFX.random.seed*a/4294967296):UFX.random.seed)},UFX.random.hash=function(a){var b=typeof a=="string"?a:JSON.stringify(a),c=b.length,d=0;for(var e=0;e<c;++e)d+=b.charCodeAt(e),d+=d<<10,d^=d>>>6;return d+=d<<3,d^=d>>>11,d+=d<<15,d<0&&(d+=4294967296),d},UFX.random.setseed=function(a){return typeof a=="undefined"?a=Math.floor(Math.random()*4294967296):typeof a=="number"?a=Math.floor(a)%4294967296:a=UFX.random.hash(a),UFX.random.seed=a,delete UFX.random.normal._y,a},UFX.random._seedstack=[],UFX.random.pushseed=function(a){return typeof UFX.random.seed=="undefined"&&UFX.random.setseed(),UFX.random._seedstack.push(UFX.random.seed),UFX.random.setseed(a),UFX.random.seed},UFX.random.popseed=function(){return UFX.random.seed=UFX.random._seedstack.pop(),UFX.random.seed},UFX.random.choice=function(a,b){return b?a.splice(UFX.random.rand(a.length),1)[0]:a[UFX.random.rand(a.length)]},UFX.random.flip=function(a){return UFX.random()<(a===undefined?.5:a)},UFX.random.word=function(a,b){var c=[];a=a||8,b=b||"abcdefghijklmnopqrstuvwxyz";for(var d=0;d<a;++d)c.push(UFX.random.choice(b));return c.join("")},UFX.random.color=function(){return"#"+UFX.random.word(6,"0123456789ABCDEF")},UFX.random.shuffle=function(a){for(var b=a.length-1;b>0;--b){var c=UFX.random.rand(b+1),d=a[b];a[b]=a[c],a[c]=d}return a},UFX.random.rdisk=function(){var a,b;do a=UFX.random(-1,1),b=UFX.random(-1,1);while(a*a+b*b>1);return[a,b]},UFX.random.rsphere=function(){var a,b,c;do a=UFX.random(-1,1),b=UFX.random(-1,1),c=UFX.random(-1,1);while(a*a+b*b+c*c>1);var d=Math.sqrt(a*a+b*b+c*c);return d===0?[0,0,1]:[a/d,b/d,c/d]},UFX.random.spread=function(a,b,c,d,e,f){a=a||100,b=b||.15,c=c||1,d=d||c,e=e||0,f=f||e;var g=[],h=1;while(g.length<a){var i=UFX.random(),j=UFX.random(),k=!0;for(var l=0;l<g.length;++l){var m=Math.abs(i-g[l][0]),n=Math.abs(j-g[l][1]);m>.5&&(m=1-m),n>.5&&(n=1-n);if(m*m+n*n<h){k=!1;break}}k?(g.push([i,j]),h=b/g.length):h*=.9}for(var l=0;l<a;++l)g[l][0]=e+g[l][0]*c,g[l][1]=f+g[l][1]*d;return g},UFX.random.spread1d=function(a,b){a=a||100,b=b||.15;var c=[],d=1;while(c.length<a){var e=UFX.random(),f=!0;for(var g=0;g<c.length;++g){var h=Math.abs(e-c[g]);h>.5&&(h=1-h);if(h<d){f=!1;break}}f?(c.push(e),d=.5*b/c.length):d*=.95}return c},UFX.random.normal=function(a,b){a=a||0,b=b||1;if(typeof UFX.random.normal._y=="number"){var c=UFX.random.normal._y;delete UFX.random.normal._y}else{var c,d,e;do c=UFX.random(-1,1),d=UFX.random(-1,1),e=c*c+d*d;while(e>1);try{e=Math.sqrt(-2*Math.log(e)/e),c*=e,d*=e}catch(f){c=d=0}UFX.random.normal._y=d}return c*b+a},"use strict";var UFX=UFX||{};UFX.texture={joinobj:function(a,b){var c=Object.create(b);if(!a)return c;for(var d in a)c[d]=a[d];return c},reduceargs:function(a){if(a.length==0)return{};var b=a[0]||{};for(var c=1;c<a.length;++c)a[c]&&(b=this.joinobj(b,a[c]));return b},makecanvas:function(a,b){var c=document.createElement("canvas");c.width=a,c.height=b,c.context=c.getContext("2d");var d=c.context.createImageData(a,b);return c.data=d.data,c.applydata=function(){c.context.putImageData(d,0,0),delete c.data},c},stat:function(){var a=this.reduceargs(arguments),b=a.width||a.size||256,c=a.height||a.size||256,d=a.rmin||0,e="rmax"in a?a.rmax:256,f=a.gmin||0,g="gmax"in a?a.gmax:256,h=a.bmin||0,i="bmax"in a?a.bmax:256,j=a.wmin||0,k=a.wmax||0;a.seed&&UFX.random.setseed(a.seed);var l=this.makecanvas(b,c),m=l.data;for(var n=0;n<b*c*4;n+=4){var o=k&&UFX.random.rand(j,k);m[n]=o+(e&&UFX.random.rand(d,e)),m[n+1]=o+(g&&UFX.random.rand(f,g)),m[n+2]=o+(i&&UFX.random.rand(h,i)),m[n+3]=255}return l.applydata(),l},grass:function(){return this.stat(this.reduceargs(arguments),{rmin:20,rmax:60,gmin:100,gmax:140,bmin:0,bmax:20})},deadgrass:function(){return this.stat(this.reduceargs(arguments),{wmin:100,wmax:120,rmin:80,rmax:100,gmin:80,gmax:100,bmin:0,bmax:0})},dirt:function(){return this.stat(this.reduceargs(arguments),{rmin:90,rmax:120,gmin:90,gmax:120,bmin:0,bmax:10})},gravel:function(){return this.stat(this.reduceargs(arguments),{wmin:60,wmax:200,rmin:0,rmax:10,gmin:0,gmax:10,bmin:0,bmax:10})},spots:function(){var a=this.reduceargs(arguments),b=a.width||a.size||256,c=a.height||a.size||256,d=a.rmin||0,e=a.rmax||256,f=a.gmin||0,g=a.gmax||256,h=a.bmin||0,i=a.bmax||256,j=a.wmin||0,k=a.wmax||0,l=1e4;a.seed&&UFX.random.setseed(a.seed);var m=document.createElement("canvas");m.width=b,m.height=c;var n=m.getContext("2d");n.globalAlpha=a.alpha||.1;for(var o=0;o<l;++o){var p=k&&UFX.random.rand(j,k),q=p+UFX.random.rand(d,e),r=p+UFX.random.rand(f,g),s=p+UFX.random.rand(h,i),t=UFX.random(b),u=UFX.random(c),v=20;n.fillStyle="rgb("+q+","+r+","+s+")",n.beginPath(),n.arc(t,u,v,0,2*Math.PI),n.fill()}return m},noisedata:function(){var a=this.reduceargs(arguments),b=a.width||a.size||256,c=a.height||a.size||256,d=a.xscale||a.scale||8,e=a.yscale||a.scale||8,f=a.fraclevel||0;a.seed&&UFX.random.setseed(a.seed);var g=256,h="xoffset"in a?a.xoffset:UFX.random(d),i="yoffset"in a?a.yoffset:UFX.random(e),j="zoffset"in a?a.zoffset:UFX.random(g),k=UFX.noise.wrapslice([b,c],j,[d,e,g],[h,i]);return f&&UFX.noise.fractalize(k,[b,c],f),k},roughshade:function(){var a=this.reduceargs(arguments),b=a.width||a.size||256,c=a.height||a.size||256,d=a.color||[0,0,0],e=a.alpha0||100,f=a.ascale||50,g=d[0],h=d[1],i=d[2],j=this.makecanvas(b,c),k=j.data,l=this.noisedata(a,{scale:64});for(var m=0,n=0,o=0;m<c;++m)for(var p=0;p<b;++p,n+=4,++o){var q=l[m*b+(p+1)%b]-l[m*b+(p+b-1)%b],r=l[(m+1)%c*b+p]-l[(m+c-1)%c*b+p];k[n]=g,k[n+1]=h,k[n+2]=i,k[n+3]=e+f*(2*q+r)}return j.applydata(),j},stone:function(){var a=this.reduceargs(arguments),b=a.width||a.size||256,c=a.height||a.size||256,d=a.color||[120,120,120],e=this.makecanvas(b,c),f=e.data,g=this.noisedata(a);for(var h=0,i=0;i<b*c;h+=4,++i){var j=150;j+=Math.max(Math.min(1e3*g[i],30),-30),j+=Math.max(100-8e3*Math.abs(g[i]),0),f[h]=j*d[0]/255,f[h+1]=j*d[1]/255,f[h+2]=j*d[2]/255,f[h+3]=255}return e.applydata(),e},terrain:function(){function q(a){if(a<=d[0][0])return[d[0][1],d[0][2],d[0][3]];for(var b=0;b<e-1;++b){var c=d[b],f=d[b+1];if(a>=c[0]&&a<f[0]){var g=(a-c[0])/(f[0]-c[0]),h=1-g;return[f[1]*g+c[1]*h,f[2]*g+c[2]*h,f[3]*g+c[3]*h]}}return[d[e-1][1],d[e-1][2],d[e-1][3]]}var a=this.reduceargs(arguments),b=a.width||a.size||256,c=a.height||a.size||256,d=a.tgrad||[[-1,0,0,192],[-0.35,0,0,255],[-0.1,0,128,255],[-0.04,240,240,64],[.08,32,160,0],[.35,160,160,0],[.5,128,128,128],[.7,255,255,255]],e=d.length,f="sealevel"in a?a.sealevel:-0.1,g=a.shadecolor||[0,0,0],h=g[0],i=g[1],j=g[2],k=a.shadex||0,l=a.shadey||0,m=(k||l)&&2*Math.exp(a.shadefactor||0)/Math.sqrt(k*k+l*l),n=this.makecanvas(b,c),o=n.data,p=this.noisedata(a,{fraclevel:3,scale:8});for(var r=0,s=0,t=0;r<c;++r)for(var u=0;u<b;++u,s+=4,++t){var v=p[t],w=q(v);if(m&&v>f){var x=p[r*b+(u+1)%b]-p[r*b+(u+b-1)%b],y=p[(r+1)%c*b+u]-p[(r+c-1)%c*b+u],z=1+(k*x+l*y)*m,A=1-z;w[0]=z*w[0]+A*m,w[1]=z*w[1]+A*m,w[2]=z*w[2]+A*m}o[s]=w[0],o[s+1]=w[1],o[s+2]=w[2],o[s+3]=255}return n.applydata(),n},clouds:function(){var a=this.reduceargs(arguments),b=a.width||a.size||256,c=a.height||a.size||256,d=a.color||[200,200,200],e=d[0],f=d[1],g=d[2],h=a.sharpness||0,i=(a.coverage||.4)-.5,j=a.shadecolor||[0,0,0],k=j[0],l=j[1],m=j[2],n=a.shadex||0,o=a.shadey||0,p=(n||o)&&.002*Math.exp(a.shadefactor||0)/Math.sqrt(n*n+o*o),q=4e3*Math.exp(h),r=this.makecanvas(b,c),s=r.data,t=this.noisedata(a,{fraclevel:2});for(var u=0,v=0,w=0;u<c;++u)for(var x=0;x<b;++x,v+=4,++w){var y=(t[w]+i)*q+128;s[v+3]=y;if(p){var z=(t[(x+n)%b+(u+o)%c*b]+i)*q+128,A=Math.min(Math.max(p*(y-z),0),1),B=1-A;s[v]=e*B+k*A,s[v+1]=f*B+l*A,s[v+2]=g*B+m*A}else s[v]=e,s[v+1]=f,s[v+2]=g}return r.applydata(),r},overcast:function(){var a=this.reduceargs(arguments),b=a.width||a.size||256,c=a.height||a.size||256,d="r0"in a?a.r0:160,e="dr"in a?a.dr:80,f="g0"in a?a.g0:160,g="dg"in a?a.dg:80,h="b0"in a?a.b0:160,i="db"in a?a.db:80,j="a0"in a?a.a0:255,k="da"in a?a.da:0,l=this.makecanvas(b,c),m=l.data,n=this.noisedata(a,{fraclevel:2,scale:8});for(var o=0,p=0;p<b*c;o+=4,++p){var q=n[p];m[o]=d+q*e,m[o+1]=f+q*g,m[o+2]=h+q*i,m[o+3]=j+q*k}return l.applydata(),l},ocean:function(){return this.overcast(this.reduceargs(arguments),{r0:40,dr:30,g0:40,dg:30,b0:160,db:60})},marble:function(){var a=this.reduceargs(arguments),b=a.width||a.size||256,c=a.height||a.size||256,d="xfactor"in a?a.xfactor:1,e="yfactor"in a?a.yfactor:2,f=(a.coverage||1.5)-.5,g=3*Math.exp(a.distortion||0),h=Math.min(30*Math.exp(a.cloudiness||0),250),i=255-h,j=1e3*Math.exp(a.sharpness||0),k=this.makecanvas(b,c),l=k.data,m=this.noisedata(a,{fraclevel:3,scale:8}),n=2*Math.PI*d/b,o=2*Math.PI*e/c;for(var p=0,q=0,r=0;p<c;++p)for(var s=0;s<b;++s,q+=4,++r){var t=m[r];t=Math.abs(Math.sin(g*t+n*s+o*p)),t=Math.min(t*j,i)+t*h,l[q]=t,l[q+1]=t,l[q+2]=t,l[q+3]=255}return k.applydata(),k},nightsky:function(){var a=this.reduceargs(arguments),b=this.overcast(a,{r0:0,dr:0,g0:0,dg:10,b0:20,db:20}),c=b.width,d=b.height,e=Math.floor(("density"in a?a.density:1)*c*d/500),f="spread"in a?a.spread:.15,g="rstar0"in a?a.rstar0:0,h="rstar1"in a?a.rstar1:.8,i=b.context;return i.beginPath(),UFX.random.spread(e,f).forEach(function(a){var b=a[0]*c,e=a[1]*d;i.moveTo(b,e),i.arc(b,e,UFX.random(g,h),0,2*Math.PI)}),i.fillStyle="white",i.fill(),b},noisestat:function(){var a=this.reduceargs(arguments),b=a.width||a.size||256,c=a.height||a.size||256,d=a.rmin||0,e="rmax"in a?a.rmax:256,f=a.gmin||0,g="gmax"in a?a.gmax:256,h=a.bmin||0,i="bmax"in a?a.bmax:256,j=a.wmin||0,k=a.wmax||0,l="dr"in a?a.dr:0,m="dg"in a?a.dg:0,n="db"in a?a.db:0,o="dw"in a?a.dw:0;a.seed&&UFX.random.setseed(a.seed);var p=this.noisedata(a),q=this.makecanvas(b,c),r=q.data;for(var s=0,t=0;t<b*c;s+=4,++t){var u=k&&UFX.random.rand(j,k)+v*o,v=p[t];r[s]=u+(e&&UFX.random.rand(d,e))+v*l,r[s+1]=u+(g&&UFX.random.rand(f,g))+v*m,r[s+2]=u+(i&&UFX.random.rand(h,i))+v*n,r[s+3]=255}return q.applydata(),q},patchygrass:function(){return this.noisestat(this.reduceargs(arguments),{wmin:40,wmax:80,dw:-40,rmin:0,rmax:20,dr:-40,gmin:60,gmax:90,dg:40,bmin:0,bmax:10})},patchydirt:function(){return this.noisestat(this.reduceargs(arguments),{wmin:40,wmax:80,dw:-20,rmin:60,rmax:80,dr:60,gmin:20,gmax:40,dg:80,bmin:0,bmax:4})},cement:function(){return this.noisestat(this.reduceargs(arguments),{wmin:120,wmax:160,dw:40,rmin:0,rmax:10,gmin:0,gmax:10,bmin:0,bmax:10})},buffertile:function(a,b){var c=b||20,d=a.width,e=a.height,f=document.createElement("canvas");f.width=d+2*c,f.height=e+2*c,f.context=f.getContext("2d");for(var g=-1;g<2;++g)for(var h=-1;h<2;++h)f.context.drawImage(a,c+d*g,c+e*h);return f.drawclip=function(a,b,g){a.save(),a.translate(b||0,g||0),a.beginPath(),a.moveTo(0,0),a.lineTo(d+.01,0),a.lineTo(d+.01,e+.01),a.lineTo(0,e+.01),a.closePath(),a.clip(),a.drawImage(f,-c,-c),a.restore()},f}},UFX.texture.tiler=function(a,b,c,d){if(this instanceof UFX.texture.tiler)this.canvas=a,this.buffer=b||2,this.nx=this.ny=0,this.makechart(c||1,d||1);else return new UFX.texture.tiler(a,b,c,d)},UFX.texture.tiler.prototype={draw:function(a,b,c,d,e){d===undefined&&(d=b,e=c,b=0,c=0);var f=this.buffer,g=this.canvas.width,h=this.canvas.height,i=((b-f)%g+g)%g+f,j=i+d,k=((c-f)%h+h)%h+f,l=k+e;this.makechart(Math.floor((j+f)/g)+1,Math.floor((l+f)/h)+1),a.save(),a.translate(b||0,c||0),a.beginPath(),a.moveTo(0,0),a.lineTo(d,0),a.lineTo(d,e),a.lineTo(0,e),a.closePath(),a.clip(),a.drawImage(this.chart,-i,-k),a.restore()},makechart:function(a,b){if(a<=this.nx&&b<=this.ny)return;this.nx=Math.max(a,this.nx),this.ny=Math.max(b,this.ny),this.chart=document.createElement("canvas"),this.chart.width=this.canvas.width*this.nx,this.chart.height=this.canvas.height*this.ny;var c=this.chart.getContext("2d");for(var d=0;d<this.nx;++d)for(var e=0;e<this.ny;++e)c.drawImage(this.canvas,d*this.canvas.width,e*this.canvas.height)}},"use strict";var UFX=UFX||{};UFX.mouse={},UFX.mouse.active=!0,UFX.mouse.qdown=!0,UFX.mouse.qup=!0,UFX.mouse.qclick=!1,UFX.mouse.qblur=!1,UFX.mouse.qwheel=!1,UFX.mouse.capture={left:!0,middle:!1,right:!1,wheel:!1},UFX.mouse.watchdrag=!0,UFX.mouse.drag={},UFX.mouse.events=function(){var a=UFX.mouse._events;return UFX.mouse._clearevents(),a},UFX.mouse.state=function(){var a={};a.pos=UFX.mouse.pos,a.pos&&UFX.mouse._opos?a.dpos=[a.pos[0]-UFX.mouse._opos[0],a.pos[1]-UFX.mouse._opos[1]]:a.dpos=[0,0],UFX.mouse._opos=a.pos,UFX.mouse.capture.left&&(a.left={}),UFX.mouse.capture.middle&&(a.middle={}),UFX.mouse.capture.right&&(a.right={});for(var b in UFX.mouse.buttonsdown)UFX.mouse.buttonsdown[b]&&a[b]&&(a[b].isdown=!0);UFX.mouse._events.forEach(function(b){a[UFX.mouse._buttonmap[b.button]][b.type]=b.pos}),UFX.mouse._clearevents(),UFX.mouse.capture.wheel&&(a.wheeldy=UFX.mouse.getwheeldy());if(UFX.mouse.watchdrag)for(var c in UFX.mouse.drag){if(!a[c]||!a[c].isdown)continue;var d=UFX.mouse.drag[c];a[c].dx=a.pos[0]-d.pos0[0],a[c].dy=a.pos[1]-d.pos0[1],a[c].dt=Date.now()-d.t0}return a},UFX.mouse._clearevents=function(){UFX.mouse._events=[]},UFX.mouse.getwheeldy=function(){var a=UFX.mouse.wheeldy;return UFX.mouse.wheeldy=0,a},UFX.mouse.pos=null,UFX.mouse._opos=null,UFX.mouse.buttonsdown={},UFX.mouse.wheeldy=0,UFX.mouse.init=function(a,b){UFX.mouse._captureevents(a,b)},UFX.mouse._events=[],UFX.mouse._captureevents=function(a,b){a=a||document,b=b||document,typeof a=="string"&&(a=document.getElementById(a)),typeof b=="string"&&(b=document.getElementById(b)),b.addEventListener("blur",UFX.mouse._onblur,!0),a.onmouseout=UFX.mouse._onmouseout,a.onmousedown=UFX.mouse._onmousedown,b.onmouseup=UFX.mouse._onmouseup,a.onclick=UFX.mouse._onclick,a.oncontextmenu=UFX.mouse._oncontextmenu,a.onmousewheel=UFX.mouse._onmousewheel,a.addEventListener("DOMMouseScroll",UFX.mouse._onmousewheel),b.onmousemove=UFX.mouse._onmousemove,UFX.mouse._element=a,UFX.mouse._backdrop=b},UFX.mouse._elemoffset=function(a){var b=a.getBoundingClientRect(),c=b.left+a.clientLeft-a.scrollLeft,d=b.top+a.clientTop-a.scrollTop;return[c,d]},UFX.mouse._geteventpos=function(a,b){b=b||a.target;var c=UFX.mouse._elemoffset(b);if(b.style.width||b.style.height){var d=b.style,e=d.width?b.width/parseFloat(d.width):b.height/parseFloat(d.height),f=d.height?b.height/parseFloat(d.height):b.width/parseFloat(d.width);return[e*(a.clientX-c[0]),f*(a.clientY-c[1])]}return[a.clientX-c[0],a.clientY-c[1]]},UFX.mouse._onblur=function(a){return UFX.mouse.active?!0:!0},UFX.mouse._onmouseout=function(a){},UFX.mouse._oncontextmenu=function(a){return!UFX.mouse.active||!UFX.mouse.capture.right?!0:(a.preventDefault(),!1)},UFX.mouse._buttonmap=["left","middle","right"],UFX.mouse._onclick=function(a){if(!UFX.mouse.active||!UFX.mouse.capture[UFX.mouse._buttonmap[a.button]])return!0;if(UFX.mouse.qclick){var b={type:"click",pos:UFX.mouse._geteventpos(a,UFX.mouse._element),button:a.button,time:Date.now(),baseevent:a};UFX.mouse._events.push(b)}return a.preventDefault(),!1},UFX.mouse._onmousedown=function(a){if(!UFX.mouse.active)return!0;var b=UFX.mouse._buttonmap[a.button];UFX.mouse.buttonsdown[b]=!0;if(!UFX.mouse.capture[b])return!0;var c=UFX.mouse._geteventpos(a);UFX.mouse.watchdrag&&(UFX.mouse.drag[b]={downevent:a,pos0:c,pos:c,dx:0,dy:0,t0:Date.now(),dt:0});if(UFX.mouse.qdown){var d={type:"down",pos:UFX.mouse._geteventpos(a,UFX.mouse._element),button:a.button,time:Date.now(),baseevent:a};UFX.mouse._events.push(d)}return a.preventDefault(),!1},UFX.mouse._onmouseup=function(a){if(!UFX.mouse.active)return!0;var b=UFX.mouse._buttonmap[a.button];UFX.mouse.buttonsdown[b]=!1;if(!UFX.mouse.capture[b])return!0;if(UFX.mouse.qup){var c={type:"up",pos:UFX.mouse._geteventpos(a,UFX.mouse._element),button:a.button,time:Date.now(),baseevent:a};UFX.mouse.drag[b]&&(c.t0=UFX.mouse.drag[b].t0,c.dt=Date.now()-c.t0,c.pos0=UFX.mouse.drag[b].pos0,c.dx=c.pos[0]-c.pos0[0],c.dy=c.pos[1]-c.pos0[1]),UFX.mouse._events.push(c)}return delete UFX.mouse.drag[b],a.preventDefault(),!1},UFX.mouse._onmousemove=function(a){if(!UFX.mouse.active)return!0;var b=UFX.mouse._geteventpos(a,UFX.mouse._element);UFX.mouse.pos=b;for(var c in UFX.mouse.drag){var d=UFX.mouse.drag[c];d.pos=b,d.dx=b[0]-d.pos0[0],d.dy=b[1]-d.pos0[1],d.dt=Date.now()-d.t0}return!1},UFX.mouse._onmousewheel=function(a){if(!UFX.mouse.active||!UFX.mouse.capture.wheel)return!0;var b="wheelDelta"in a?a.wheelDelta/40:-a.detail;UFX.mouse.wheeldy+=b;if(UFX.mouse.qwheel){var c={type:"wheel",pos:UFX.mouse._geteventpos(a,UFX.mouse._element),dy:b,time:Date.now(),baseevent:a};UFX.mouse._events.push(c)}return a.preventDefault(),!1},"use strict";var UFX=UFX||{};UFX.key={},UFX.key.active=!0,UFX.key.capture=!0,UFX.key.qdown=!0,UFX.key.qup=!0,UFX.key.qcombo=!1,UFX.key.combodt=100,UFX.key.watchlist=null,UFX.key.ispressed={},UFX.key.codepressed={},UFX.key.events=function(){var a=UFX.key._downevents.concat(UFX.key._upevents);return UFX.key.clearevents(),a},UFX.key.combos=function(){UFX.key._checkcombo();var a=UFX.key._combos;return UFX.key.clearcombos(),a},UFX.key.clearevents=function(){UFX.key._downevents=[],UFX.key._upevents=[]},UFX.key.clearcombos=function(a){UFX.key._combos=[],a&&(UFX.key._currentcombo=null)},UFX.key.state=function(){var a={pressed:{}};for(var b in UFX.key.ispressed)UFX.key.ispressed[b]&&(a.pressed[b]=1);return UFX.key.qdown&&(a.down={}),UFX.key.qup&&(a.up={}),UFX.key.events().forEach(function(b){a[b.type][b.name]=1}),UFX.key.qcombo&&(a.combo={},UFX.key.combos().forEach(function(b){a.combo[b.kstring]=1})),a},UFX.key.init=function(a){UFX.key._captureevents(a)},UFX.key.map={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"caps",27:"esc",32:"space",33:"pgup",34:"pgdn",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:"semicolon",61:"equals",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",96:"np0",97:"np1",98:"np2",99:"np3",100:"np4",101:"np5",102:"np6",103:"np7",104:"np8",105:"np9",106:"star",107:"plus",109:"hyphen",110:"period",111:"slash",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"num",188:"comma",190:"period",191:"slash",192:"backtick",219:"openbracket",220:"backslash",221:"closebracket",222:"apostrophe"},UFX.key.remap=function(){for(var a=0;a<arguments.length;++a){var b=arguments[a];for(var c in b){var d=b[c];for(var e in UFX.key.map)UFX.key.map[e]===c&&(UFX.key.map[e]=d)}}},UFX.key.remaparrows=function(a){UFX.key.remap({A:"left",S:"down",D:"right",W:"up"}),a&&UFX.key.remap({O:"down",comma:"up",",":"up",E:"right"})},UFX.key.remappunct=function(){UFX.key.remap({semicolon:";",equals:"=",star:"*",plus:"+",hyphen:"-",period:".",slash:"/",comma:",",backtick:"`",openbracket:"[",backslash:"\\",closebracket:"]",apostrophe:"'"})},UFX.key._downevents=[],UFX.key._upevents=[],UFX.key._combos=[],UFX.key._currentcombo=null,UFX.key._captureevents=function(a){a=a||document,typeof a=="String"&&(a=document.getElementById(a)),a.addEventListener("blur",UFX.key._onblur,!0),window.onblur=UFX.key._onblur,a.onkeypress=UFX.key._onkeypress,a.onkeyup=UFX.key._onkeyup,a.onkeydown=UFX.key._onkeydown,UFX.key._element=a},UFX.key._onblur=function(a){for(var b in UFX.key.codepressed)UFX.key._storeup(a,b);return!0},UFX.key._watching=function(a){return UFX.key.watchlist?UFX.key.watchlist.indexOf(UFX.key.map[a.which])>-1:!0},UFX.key._onkeypress=function(a){return!UFX.key.active||!UFX.key._watching(a)?!0:!UFX.key.capture},UFX.key._onkeydown=function(a){if(!UFX.key.active||!UFX.key._watching(a))return!0;var b=a.which;return UFX.key.codepressed[b]?!UFX.key.capture:(UFX.key._storedown(a,b),!UFX.key.capture)},UFX.key._onkeyup=function(a){return!UFX.key.active||!UFX.key._watching(a)?!0:(UFX.key._storeup(a,a.which),!UFX.key.capture)},UFX.key._storedown=function(a,b){b=b||a.which;var c=(new Date).getTime(),d=UFX.key.map[b]||"key#"+b,e={baseevent:a,type:"down",code:b,name:d,time:c};UFX.key.codepressed[b]=e,e.name&&(UFX.key.ispressed[e.name]=e),UFX.key.qdown&&UFX.key._downevents.push(e),UFX.key.qcombo&&(UFX.key._checkcombo(),UFX.key._currentcombo?UFX.key._currentcombo.keys.push(d):UFX.key._currentcombo={start:c,keys:[d]})},UFX.key._storeup=function(a,b){var c=(new Date).getTime(),d=UFX.key.codepressed[b]?c-UFX.key.codepressed[b].time:0,e={type:"up",baseevent:a,code:b,name:UFX.key.map[b]||"key#"+b,time:c,dt:d};delete UFX.key.codepressed[b],e.name&&delete UFX.key.ispressed[e.name],UFX.key.qup&&UFX.key._upevents.push(e)},UFX.key._checkcombo=function(){if(!UFX.key._currentcombo)return;var a=(new Date).getTime();if(UFX.key._currentcombo.start+UFX.key.combodt<a){var b=UFX.key._currentcombo.keys;b.sort(),UFX.key._combos.push({keys:b,kstring:b.join(" "),time:UFX.key._currentcombo.start}),UFX.key._currentcombo=null}},"use strict";var UFX=UFX||{};UFX.maximize={resizemode:"fixed",preventscroll:!0,fillcolor:"black",onadjust:null,init:function(a){function b(a,b){return function(){a[b]()}}this.element=a,this.mode=null,this.calladjust=b(this,"adjust"),this.getsettings()},setmode:function(a){if(this.mode==a)return;this.mode=="fill"&&window.removeEventListener("resize",this.calladjust),this.mode=="full"&&(document.cancelFullscreen(),window.removeEventListener("resize",this.calladjust)),this.mode=a,this.mode=="fill"&&window.addEventListener("resize",this.calladjust),this.mode=="full"&&(this.element.requestFullscreen(),window.addEventListener("resize",this.calladjust))},adjust:function(){var a=window.innerWidth,b=window.innerHeight,c=this.element.width,d=this.element.height,e,f,g,h;this.resizemode!="none"&&(this.resizemode=="fixed"?c*b>d*a?(e=a,f=Math.round(a*d/c)):(e=Math.round(b*c/d),f=b):this.resizemode=="aspect"?c*b>d*a?(g=e=a,h=f=Math.round(a*d/c)):(g=e=Math.round(b*c/d),h=f=b):this.resizemode=="total"&&(g=e=a,h=f=b));var i=this.element.style;e&&(i.width=e+"px",i.height=f+"px"),g&&(this.element.width=g,this.element.height=h);if(this.mode=="fill"){var j=a-(e||g||this.element.width),k=b-(f||h||this.element.height);i.borderLeft=i.borderRight=j>0?.5*j+1+"px "+this.fillcolor+" solid":"none",i.borderTop=i.borderBottom=k>0?.5*k+1+"px "+this.fillcolor+" solid":"none",setTimeout(function(){window.scrollTo(0,1)},1)}else this.mode=="full"&&(i.borderLeft=i.borderRight="none",i.borderTop=i.borderBottom="none");this.onadjust&&this.onadjust(this.element,this.element.width,this.element.height)},fill:function(a,b){b&&(this.resizemode=b),a&&this.init(a),this.setmode("fill"),this.preventscroll&&(document.body.addEventListener("touchstart",this.preventdefault),this.scrollprevented=!0),this.adjust();var c=this.element.style;c.position="absolute",c.left="0px",c.top="1px",document.body.style.overflow="hidden"},full:function(a,b){b&&(this.resizemode=b),a&&this.init(a),this.setmode("full");var c=this;setTimeout(function(){c.getfullscreenelement()===c.element?c.adjust():c.restore()},100)},maximize:function(a,b){b&&(this.resizemode=b),a&&this.init(a);if(!this.element.requestFullscreen){this.fill();return}this.setmode("full");var c=this;setTimeout(function(){c.getfullscreenelement()!==c.element&&c.fill()},100)},getfullscreenelement:function(){return document.getFullscreenElement},restore:function(){this.setmode(),this.scrollprevented&&(document.body.removeEventListener("touchstart",this.preventdefault),this.scrollprevented=!1),this.restoresettings(),this.onadjust&&this.onadjust(this.element,this.element.width,this.element.height)},getsettings:function(){var a=this.element.style,b=this.settings={width:this.element.width,height:this.element.height,overflow:document.body.style.overflow,style:{}},c="width height position left top borderLeft borderRight borderTop borderBottom border".split(" ");c.forEach(function(c){b.style[c]=a[c]})},restoresettings:function(){var a=this.element.style,b=this.settings;this.element.width=this.settings.width,this.element.height=this.settings.height,document.body.style.overflow=this.settings.overflow;var c="width height position left top borderLeft borderRight borderTop borderBottom border".split(" ");c.forEach(
function(c){a[c]=b.style[c]})},fillnoresize:function(){es.position="absolute",es.left="0px",es.top="1px",this.setbordersizes(wx-px,wy-py),document.body.style.overflow="hidden"},preventdefault:function(a){a.preventDefault()}},"use strict";var UFX=UFX||{};UFX.SceneStack=function(){if(this instanceof UFX.SceneStack)this._actionq=[],this._stack=[],this.resolveargs=!0,this.recorder=null,this.frozen=!1;else return new UFX.SceneStack},UFX.SceneStack.prototype={init:function(a,b){a=Object.create(a||null),a.cthis=this,UFX.ticker.init(this.think,this.draw,a,b)},top:function(){var a=this._stack.length;return a?this._stack[a-1]:null},getscene:function(a){if(typeof a=="string"){if(a.substr(0,4)=="new_"){a=a.substr(4);if(a in UFX.scenes)return new UFX.scenes[a];throw"Unrecognized scene: "+a}if(a.substr(0,7)=="create_"){a=a.substr(7);if(a in UFX.scenes)return Object.create(UFX.scenes[a]);throw"Unrecognized scene: "+a}if(a in UFX.scenes)return UFX.scenes[a];throw"Unrecognized scene: "+a}return a},ipush:function(a){if(this.frozen)return;var b=this.top();b&&b.suspend&&b.suspend();var c=this.getscene(a);this._stack.push(c);var d=Array.prototype.slice.call(arguments,1);this.resolveargs&&c.startargs&&(d=c.startargs.apply(c,d)),this.recorder&&this.recorder.addpush(a,d),c.checkpoint&&this.recorder&&this.recorder.checkpoint(c.getchaptername?c.getchaptername.apply(c,d):a),c.start&&c.start.apply(c,d)},ipop:function(a){if(this.frozen)return;a=a||1;for(var b=0;b<a;++b){var c=this._stack.pop();c.stop&&c.stop();var d=this.top();d&&d.resume&&d.resume(),this.recorder&&this.recorder.addpop()}return c},iswap:function(a){if(this.frozen)return;var b=this._stack.pop();b&&b.stop&&b.stop();var c=this.getscene(a);this._stack.push(c);var d=Array.prototype.slice.call(arguments,1);return this.resolveargs&&c.startargs&&(d=c.startargs.apply(c,d)),this.recorder&&this.recorder.addswap(a,d),c.checkpoint&&this.recorder&&this.recorder.checkpoint(c.getchaptername?c.getchaptername.apply(c,d):a),c.start&&c.start.apply(c,d),b},push:function(){this._actionq.push(["push",Array.prototype.slice.call(arguments,0)])},pop:function(){this._actionq.push(["pop",Array.prototype.slice.call(arguments,0)])},swap:function(){this._actionq.push(["swap",Array.prototype.slice.call(arguments,0)])},_resolveq:function(){for(var a=0;a<this._actionq.length;++a)switch(this._actionq[a][0]){case"push":this.ipush.apply(this,this._actionq[a][1]);break;case"pop":this.ipop.apply(this,this._actionq[a][1]);break;case"swap":this.iswap.apply(this,this._actionq[a][1])}this._actionq=[]},think:function(){this._resolveq();var a=this.top();this._lastthinker=a;if(a){var b=arguments;this.resolveargs&&a.thinkargs&&(b=a.thinkargs.apply(a,b)),this.recorder&&this.recorder.addthink(b),a.think&&a.think.apply(a,b)}},draw:function(){var a=this._lastthinker;a&&a.draw&&a.draw.apply(a,arguments)}},UFX.scene=new UFX.SceneStack,UFX.scenes={},"use strict",UFX.Recorder=function(a){if(this instanceof UFX.Recorder)this.init(a);else return new UFX.Recorder(a)},UFX.Recorder.prototype={init:function(a){return a=a||{},this.sessionstart=Date.now(),this.setnames(a.gamename,a.version,a.playername,a.sessionname),this.setstatefuncs(a.getprestate,a.getstate,a.getpoststate),this.sethandler(a.handler),this.setscene(a.scene||UFX.scene,a.tethered,a.tetherswap),this.postscript=a.postscript,this.keepchapters=a.keepchapters,this.copystate=!0,this.session},setnames:function(a,b,c,d){this.gamename=a,this.version=b===undefined?"":b,this.playername=c||"",this.sessionname=d||this.playername+"-"+this.sessionstart},setstatefuncs:function(a,b,c){this.getprestate=a,this.getstate=b,this.getpoststate=c},sethandler:function(a){this.handler=a||{}},setscene:function(a,b,c){this.scene&&(this.scene.recorder=null),this.scene=a,this.nchapters=0;if(this.scene){if(this.scene.recorder)throw"Specified recording scene already has associated playback";this.scene.recorder=this,this.prestate=this.getprestate&&this.getprestate(),this.prestate&&this.copystate&&(this.prestate=JSON.parse(JSON.stringify(this.prestate))),this.state=[],this.chapters=[],this.startchapter(),this.tethered=b,this.tetherswap=c}this.session={gamename:this.gamename,version:this.version,playername:this.playername,name:this.sessionname,chapters:this.chapters,nchapters:this.nchapters,t:this.sessionstart}},stop:function(){this.completechapter();var a=this.session;return this.setscene(),a},startchapter:function(a){var b=this.chapter;return this.poststate=this.getpoststate&&this.getpoststate(),this.poststate&&this.copystate&&(this.poststate=JSON.parse(JSON.stringify(this.poststate))),this.chapter={n:this.nchapters++,name:a,t:Date.now(),duration:0,prestate:this.prestate,state:this.state.slice(0),poststate:this.poststate,data:[]},this.chapters.push(this.chapter),this.data=this.chapter.data,this.lastdatum=null,b},completechapter:function(){var a=this.nchapters-1;this.chapters[a].duration=Date.now()-this.chapters[a].t;if(this.postscript)this.pushchapter(a),this.keepchapters||(this.chapters[a]=null);else return this.chapters[a]},checkpoint:function(a){if(!this.chapter.data.length)return;var b=this.completechapter();return this.startchapter(a),b},addpush:function(a,b){var c=this.getstate&&this.getstate();c&&this.copystate&&(c=JSON.parse(JSON.stringify(c))),this.lastdatum=[Date.now(),"push",a,b,c],this.data.push(this.lastdatum),this.state.push([a,b,c])},addpop:function(){this.lastdatum=[Date.now(),"pop"],this.data.push(this.lastdatum),this.state.pop(),!this.state.length&&this.tethered&&this.stop()},addswap:function(a,b){var c=this.getstate&&this.getstate();c&&this.copystate&&(c=JSON.parse(JSON.stringify(c))),this.lastdatum=[Date.now(),"swap",a,b,c],this.data.push(this.lastdatum),this.state.pop(),!this.state.length&&this.tethered&&!this.tetherswap&&this.stop(),this.state.push([a,b,c])},addthink:function(a){if(this.paused||this.scene.top().clipplayback)return this.addclip();if(!this.lastdatum||this.lastdatum[1]!=="think")this.lastdatum=[Date.now(),"think"],this.data.push(this.lastdatum);this.lastdatum.push(a)},addclip:function(){if(!this.lastdatum||this.lastdatum[1]!=="clip")this.lastdatum=[Date.now(),"clip",0,null],this.data.push(this.lastdatum);this.lastdatum[2]++,this.lastdatum[3]=Date.now()},log:function(){this.lastdatum=[Date.now(),"log"],this.lastdatum.push.apply(this.lastdatum,arguments),this.data.push(this.lastdatum)},handle:function(a){if(typeof a!="string")throw"Invalid event type: "+a;switch(a){case"push":this.addpush(arguments[1],arguments[2]);break;case"pop":this.addpop();break;case"swap":this.addswap(arguments[1],arguments[2]);break;case"think":this.addthink(arguments[1]);break;case"clip":this.addclip();break;case"log":this.log.apply(this,Array.prototype.slice.call(arguments,1));break;default:var b=Array.prototype.slice.call(arguments,1);this.lastdatum=[Date.now(),a,b],this.data.push(this.lastdatum),this.handler[a]&&this.handler[a].apply(null,b)}},pushchapter:function(a){var b=new XMLHttpRequest;b.open("POST",this.postscript,!0),b.setRequestHeader("Content-type","application/x-www-form-urlencoded");var c=["act=postchapter","gamename="+encodeURIComponent(this.session.gamename),"gameversion="+encodeURIComponent(this.session.version),"sessionname="+encodeURIComponent(this.session.name),"sessiontime="+encodeURIComponent(this.session.t),"playername="+encodeURIComponent(this.playername),"chapternumber="+encodeURIComponent(a),"chaptertime="+encodeURIComponent(this.chapters[a].t),"chapterduration="+encodeURIComponent(this.chapters[a].duration),"chapterdata="+encodeURIComponent(JSON.stringify(this.chapters[a]))];b.send(c.join("&")),this.req=b}},UFX.Playback=function(a,b){if(this instanceof UFX.Playback)this.session=a,this.init(b),this.playing=!1,this.stack=new UFX.SceneStack,this.stack.resolveargs=!1;else return new UFX.Playback(a,b)},UFX.Playback.prototype={init:function(a){a=a||{},this.setstatefuncs(a.setprestate,a.setstate,a.setpoststate),this.sethandler(a.handler),this.setscene(a.scene||UFX.scene),this.raw=a.raw,this.syncfactor=a.syncfactor||1,this.sync=a.sync,this.persistonstop=a.persistonstop,this.ontakedown=a.ontakedown,this.cancelcallback=a.cancelcallback},setstatefuncs:function(a,b,c){this.setprestate=a,this.setstate=b,this.setpoststate=c},sethandler:function(a){this.handler=a||{}},setscene:function(a){this.scene=a},playall:function(){this.jchapter=0,this.t=0,this.playing=!0,this.loadchapter(),this.scene.ipush(Object.create(this.PlayScene),this),this.scene.frozen=!0},playraw:function(){this.raw=!0,this.playall()},stop:function(){this.playing=!1,this.persistonstop||this.takedown()},takedown:function(){this.scene.frozen=!1,this.scene.ipop(),this.raw&&(this.scene._stack=this.stack._stack.slice()),this.ontakedown&&this.ontakedown()},loadchapter:function(){if(!this.session.chapters[this.jchapter])return!1;this.chapter=JSON.parse(JSON.stringify(this.session.chapters[this.jchapter])),this.setprestate&&this.setprestate.apply(null,this.chapter.prestate),this.stack._stack=[],this.raw&&(this.stack._stack=this.scene._stack.slice()),this.stack._lastthinker=null;var a=this.chapter.state;for(var b=0;b<a.length;++b)this.applypush(a[b][0],a[b][1],a[b][2]);return this.setpoststate&&this.setpoststate.apply(null,this.chapter.poststate),this.jdatum=0,this.jthink=0,this.chaptert=0,!0},nextdatum:function(){if(this.jdatum>=this.chapter.data.length)return;var a=this.chapter.data[this.jdatum];return a[1]==="think"?(this.jthink<2&&(this.jthink=2),this.jthink<a.length?[a[0],a[1],a[this.jthink++]]:(this.jdatum++,this.jthink=0,this.nextdatum())):(this.jdatum++,a)},applypush:function(a,b,c){return this.setstate&&this.setstate.apply(null,c),this.stack.ipush.apply(this.stack,[a].concat(b))},applypop:function(){this.stack.ipop()},applyswap:function(a,b,c){var d=this.stack._stack.pop();d&&d.stop&&d.stop(),this.setstate&&this.setstate.apply(null,c);var e=this.stack.getscene(a);return this.stack._stack.push(e),e.start&&e.start.apply(e,b),d},applythink:function(a){this.stack.think.apply(this.stack,a),this.sync&&(this.t+=a[0],this.chaptert+=a[0])},applyclip:function(){},getlogs:function(a){a==undefined&&(a=this.jchapter);var b=[],c=this.session.chapters[a];return c.data.forEach(function(a){a[1]=="log"&&b.push(a.slice(2))}),b},alllogs:function(){var a=[];return this.session.chapters.forEach(function(b){var c=b.name||b.n;b.data.forEach(function(b){if(b[1]!="log")return;var d=b.slice(2);d.splice(0,0,c),a.push(d)})}),a},handle:function(a,b){if(typeof b!="string")throw"Invalid event type: "+b;switch(b){case"push":this.applypush(arguments[2],arguments[3],arguments[4]);break;case"pop":this.applypop();break;case"swap":this.applyswap(arguments[2],arguments[3],arguments[4]);break;case"think":this.applythink(arguments[2]);break;case"clip":this.applyclip();break;default:var c=Array.prototype.slice.call(arguments,2);this.handler[b]&&this.handler[b].apply(null,c)}},step:function(){var a=this.nextdatum();return a?(this.handle.apply(this,a),!0):(this.jchapter++,this.loadchapter()&&this.step())},PlayScene:{start:function(a){this.playback=a,this.t=0},think:function(a){if(!this.playback.playing)return;if(this.playback.sync){this.t+=a*this.playback.syncfactor;while(this.t>this.playback.t)if(!this.playback.step()){this.playback.stop();return}}else this.playback.step()||this.playback.stop()},draw:function(){if(!this.playback.playing)return;this.playback.stack.draw()}}},"use strict";var UFX=UFX||{};UFX.noise=function(a,b){var c=a.length,d=new Array(c),e=new Array(c);for(var f=0;f<c;++f){var g=b?b[f]:256,h=Math.floor(a[f])%g;h<0&&(h+=g),d[f]=[h,(h+1)%g],e[f]=a[f]-Math.floor(a[f])}var i=0;for(var j=0,k=1<<c;j<k;++j){var l=new Array(c);for(var f=0;f<c;++f)l[f]=d[f][j>>f&1];var m=0,n=1;for(var f=0;f<c;++f){var o=UFX.noise._gvalue(l,f),p=j>>f&1?1-e[f]:-e[f];m+=o*p,n*=1-p*p*(3-2*Math.abs(p))}i+=m*n}return i/1e3/Math.sqrt(c)},UFX.noise.wrap2d=function(a,b,c,d){var e=a[0],f=a[1],g=e*f,h=new Array(g),i=new Array(e),j=new Array(e),k=new Array(e),l=new Array(e),m=new Array(e),n=new Array(e);b=b||[8,8];var o=b[0],p=b[1],q=o*p;d=d||[0,0];var r=new Array(q),s=new Array(q);for(var t=0,u=0;t<p;++t)for(var v=0;v<o;++v,++u)r[u]=UFX.noise._gvalue([v+d[0],t+d[1]],0),s[u]=UFX.noise._gvalue([v+d[0],t+d[1]],1);c=c||[0,0];for(var w=0;w<e;++w){var x=(w+.5)*o/e+c[0];i[w]=Math.floor(x)%o,i[w]<0&&(i[w]+=o),j[w]=(i[w]+1)%o;var y=x-Math.floor(x),z=1-y;k[w]=y,l[w]=z,m[w]=y*y*(3-2*y),n[w]=1-m[w]}for(var A=0,B=0;A<f;++A){var C=(A+.5)*p/f+c[1],D=Math.floor(C)%p;D<0&&(D+=p);var E=(D+1)%p,F=C-Math.floor(C),G=1-F,H=F*F*(3-2*F),I=1-H;for(var w=0;w<e;++w,++B){var J=i[w],K=j[w],y=k[w],z=l[w],L=m[w],M=n[w],N=J+D*o,O=J+E*o,P=K+D*o,Q=K+E*o;h[B]=((-y*r[N]-F*s[N])*I+(-y*r[O]+G*s[O])*H)*M+((z*r[P]-F*s[P])*I+(z*r[Q]+G*s[Q])*H)*L,h[B]/=1414.213}}return h},UFX.noise.wrapslice=function(a,b,c,d,e){var f=a[0],g=a[1],h=f*g,i=new Array(h),j=new Array(f),k=new Array(f),l=new Array(f),m=new Array(f),n=new Array(f),o=new Array(f);c=c||[8,8,256],c.length==2&&(c=[c[0],c[1],256]);var p=c[0],q=c[1],r=c[2],s=p*q;e=e||[0,0];var t=Math.floor(b)%r;t<0&&(t+=r);var u=(t+1)%r,v=b-Math.floor(b),w=1-v,x=v*v*(3-2*v),y=1-x,z=new Array(s),A=new Array(s),B=new Array(s),C=new Array(s),D=new Array(s),E=new Array(s);for(var F=0,G=0;F<q;++F)for(var H=0;H<p;++H,++G)z[G]=UFX.noise._gvalue([H+e[0],F+e[1],t],0),A[G]=UFX.noise._gvalue([H+e[0],F+e[1],t],1),B[G]=UFX.noise._gvalue([H+e[0],F+e[1],t],2),C[G]=UFX.noise._gvalue([H+e[0],F+e[1],u],0),D[G]=UFX.noise._gvalue([H+e[0],F+e[1],u],1),E[G]=UFX.noise._gvalue([H+e[0],F+e[1],u],2);d=d||[0,0];for(var I=0;I<f;++I){var J=(I+.5)*p/f+d[0];j[I]=Math.floor(J)%p,j[I]<0&&(j[I]+=p),k[I]=(j[I]+1)%p;var K=J-Math.floor(J),L=1-K;l[I]=K,m[I]=L,n[I]=K*K*(3-2*K),o[I]=1-n[I]}for(var M=0,N=0;M<g;++M){var O=(M+.5)*q/g+d[1],P=Math.floor(O)%q;P<0&&(P+=q);var Q=(P+1)%q,R=O-Math.floor(O),S=1-R,T=R*R*(3-2*R),U=1-T;for(var I=0;I<f;++I,++N){var V=j[I],W=k[I],K=l[I],L=m[I],X=n[I],Y=o[I],Z=V+P*p,$=V+Q*p,_=W+P*p,ba=W+Q*p;i[N]=(((-K*z[Z]-R*A[Z]-v*B[Z])*U+(-K*z[$]+S*A[$]-v*B[$])*T)*Y+((L*z[_]-R*A[_]-v*B[_])*U+(L*z[ba]+S*A[ba]-v*B[ba])*T)*X)*y+(((-K*C[Z]-R*D[Z]+w*E[Z])*U+(-K*C[$]+S*D[$]+w*E[$])*T)*Y+((L*C[_]-R*D[_]+w*E[_])*U+(L*C[ba]+S*D[ba]+w*E[ba])*T)*X)*x,i[N]/=1732.051}}return i},UFX.noise.fractalize=function(a,b,c){var d=b[0],e=b[1],f=d/2,g=e/2,h=f*g;if(f<2||g<2)return;var i=new Array(f*g);for(var j=0,k=0;j<e;j+=2){var l=j*d;for(var m=0;m<d;m+=2,++k)i[k]=a[l+m]}c!==1&&UFX.noise.fractalize(i,[f,g],typeof c=="number"?c-1:c);for(var k=0;k<h;++k)i[k]*=.5;for(var n=0,o=0;n<g;++n)for(var p=0;p<f;++p,++o){var q=i[o];a[n*d+p]+=q,a[n*d+p+f]+=q,a[(n+g)*d+p]+=q,a[(n+g)*d+p+f]+=q}},UFX.noise._grad=[-2885,-2520,-2335,-2206,-2106,-2024,-1953,-1891,-1835,-1785,-1739,-1696,-1656,-1618,-1583,-1550,-1518,-1488,-1459,-1431,-1404,-1378,-1353,-1329,-1306,-1283,-1261,-1240,-1219,-1199,-1179,-1159,-1140,-1122,-1104,-1086,-1068,-1051,-1034,-1018,-1001,-985,-970,-954,-939,-924,-909,-894,-879,-865,-851,-837,-823,-809,-796,-783,-769,-756,-743,-730,-718,-705,-693,-680,-668,-656,-644,-632,-620,-608,-596,-584,-573,-561,-550,-539,-527,-516,-505,-494,-483,-472,-461,-450,-439,-428,-418,-407,-396,-386,-375,-365,-354,-344,-334,-323,-313,-303,-292,-282,-272,-262,-252,-242,-232,-222,-212,-202,-192,-182,-172,-162,-152,-142,-132,-122,-112,-102,-93,-83,-73,-63,-53,-44,-34,-24,-14,-4,4,14,24,34,44,53,63,73,83,93,102,112,122,132,142,152,162,172,182,192,202,212,222,232,242,252,262,272,282,292,303,313,323,334,344,354,365,375,386,396,407,418,428,439,450,461,472,483,494,505,516,527,539,550,561,573,584,596,608,620,632,644,656,668,680,693,705,718,730,743,756,769,783,796,809,823,837,851,865,879,894,909,924,939,954,970,985,1001,1018,1034,1051,1068,1086,1104,1122,1140,1159,1179,1199,1219,1240,1261,1283,1306,1329,1353,1378,1404,1431,1459,1488,1518,1550,1583,1618,1656,1696,1739,1785,1835,1891,1953,2024,2106,2206,2335,2520,2885],UFX.noise._perm=[127,13,214,153,195,181,253,32,17,180,95,9,159,81,209,129,31,157,21,76,118,79,91,0,38,234,8,147,148,227,206,78,22,223,198,109,240,46,115,71,133,175,232,14,168,37,196,49,213,106,62,119,85,61,104,220,139,203,44,73,189,237,39,210,28,57,6,172,164,40,51,186,233,52,204,199,50,243,161,126,249,7,36,244,131,231,24,1,252,142,27,53,188,254,137,184,92,201,136,165,43,145,205,216,33,19,101,75,156,60,228,215,197,185,248,30,26,200,107,96,11,247,173,111,108,235,166,241,105,120,47,110,130,167,112,208,160,154,42,16,48,34,202,221,74,122,236,64,143,246,103,88,222,238,162,155,163,80,230,72,25,176,68,158,121,124,63,177,113,41,3,45,86,55,114,67,134,212,58,242,179,192,35,170,211,15,149,224,140,66,128,219,193,2,229,117,93,54,132,135,218,169,187,207,191,144,138,245,190,65,23,146,123,56,152,194,171,18,4,100,150,255,99,98,183,83,70,97,141,178,182,250,84,10,239,217,94,116,174,29,151,82,12,225,59,125,20,5,69,251,77,102,90,89,226,87],UFX.noise._gvalue=function(a,b){var c=UFX.noise._perm[b];for(var d=0;d<a.length;++d)c=UFX.noise._perm[c+a[d]&255];return UFX.noise._grad[c]},"use strict";var UFX=UFX||{};UFX.Tracer=function(a,b,c){var d=Object.create(UFX.Tracer.prototype);return d.spec=a,typeof a=="function"&&(d.trace=a),d.x0=b[0],d.y0=b[1],d.w=b[2],d.h=b[3],d.zmax=c||4,d.imgs={},d.showbox=!1,d},UFX.Tracer.prototype={trace:function(a){typeof this.spec=="function"?this.spec(a):a?UFX.draw(a,this.spec):UFX.draw(this.spec)},choosez:function(a){if(a>this.zmax)return null;var b=1;while(a>b)b*=2;while(a<b/2)b/=2;return b},draw:function(a,b){var c=this.choosez(a||1);if(!c)this.trace(b);else{c in this.imgs||this.makeimg(c),b=b||UFX.draw._context;if(UFX.Tracer.showbox||this.showbox)b.fillStyle="rgba(255,128,0,0.3)",b.fillRect(this.x0,this.y0,this.w,this.h);c==1?b.drawImage(this.imgs[1],this.x0,this.y0):(b.save(),b.scale(1/c,1/c),b.drawImage(this.imgs[c],this.x0*c,this.y0*c),b.restore())}},makeimg:function(a){var b=document.createElement("canvas");b.width=this.w*a,b.height=this.h*a;var c=b.getContext("2d");c.save(),c.scale(a,a),c.translate(-this.x0,-this.y0),this.trace(c),c.restore(),this.imgs[a]=b}},"use strict";var UFX=UFX||{};UFX.Thing=function(){var a=Object.create(UFX.Thing.prototype);for(var b=0;b<arguments.length;++b)a.addcomp(arguments[b]);return a},UFX.Thing.prototype={_createmethod:function(a,b,c){c=c||[];var d;return b?b==="any"?d=function(){var a;for(var b=0;b<c.length;++b){a=c[b].apply(this,arguments);if(a)return a}return a}:b==="all"?d=function(){var a;for(var b=0;b<c.length;++b){a=c[b].apply(this,arguments);if(!a)return a}return a}:b==="getarray"?d=function(){var a=[];for(var b=0;b<c.length;++b)a.push(c[b].apply(this,arguments));return a}:b==="putarray"&&(d=function(a){var b=[];for(var d=0;d<c.length;++d)b.push(c[d].apply(this,a[d]));return b}):d=function(){var a;for(var b=0;b<c.length;++b)a=c[b].apply(this,arguments);return a},d.mlist=c,d},definemethod:function(a,b){return this[a]?this:(this[a]=this._createmethod(a,b),this)},addcomp:function(a){if(a instanceof Array){var b=a.slice(0);for(var c=0;c<b.length;++c)arguments[0]=b[c],this.addcomp.apply(this,arguments);return this}for(var d in a){if(d=="init"||d=="remove")continue;if(typeof a[d]!="function")continue;this.definemethod(d),this[d].mlist.push(a[d])}return a.init&&a.init.apply(this,[].slice.call(arguments,1)),this},removecomp:function(a){if(a instanceof Array){var b=a.slice(0);for(var c=0;c<b.length;++c)arguments[0]=b[c],this.removecomp.apply(this,arguments);return this}a.remove&&a.remove.apply(this,[].slice.call(arguments,1));for(var d in a){if(d=="init"||d=="remove")continue;if(d in this)this[d].mlist=this[d].mlist.filter(function(b){return b!==a[d]});else continue}return this},reversemethods:function(a){return this[a].mlist.reverse(),this},setmethodmode:function(a,b){return this[a]=this._createmethod(a,b,this[a]?this[a].mlist:[]),this},normalize:function(){for(mname in this)this.hasOwnProperty(mname)&&this[mname].mlist&&this[mname].mlist.length==1&&(this[mname]=this[mname].mlist[0])}},UFX.Component={},UFX.Component.HasChildren={init:function(){this.children=[]},nchildren:function(){return this.children.length},_addchild:function(a){return this.children.push(a),this},_removechild:function(a){return this.children=this.children.filter(function(b){return b!==a}),this},lastchild:function(){return this.children[this.children.length-1]},die:function(){for(var a=0;a<this.children.length;++a)this.children[a].die()},think:function(){for(var a=0;a<this.children.length;++a)this.children[a].think.apply(this.children[a],arguments)},draw:function(a){for(var b=0;b<this.children.length;++b)a.save(),this.children[b].draw(a),a.restore()}},UFX.Component.SortChildren={init:function(a){this.childsortfunc=a||function(a,b){return a.z-b.z}},addchild:function(a){this.children.sort(this.childsortfunc)}},UFX.Component.HasParent={init:function(a){this.attachto(a)},attachto:function(a){return this.parent&&this.parent._removechild(this),this.parent=a,this.parent&&this.parent._addchild(this),this},detach:function(){return this.attachto()},die:function(){return this.detach()}},"use strict";var UFX=UFX||{};UFX.touch={capture:{start:!0,end:!0,tap:!0,hold:!0,swipe:!0,release:!0},active:!0,multi:!0,touchmax:0,tmulti:100,usetouchid:!0,ps:[],qtap:!0,qdrag:!0,thold:300,roundpos:!0,dmove:50,_events:[],_mtouch:0,_touches:{},_tkeys:[],_ntouches:0,init:function(a,b){this._captureevents(a,b)},events:function(){this._checkhold();var a=this._events;return this._events=[],a},state:function(){var a={ps:{},deltas:{}},b=this.capture,c=this.usetouchid;for(var d in b)a[d]=[];this.events().forEach(function(d){if(!b[d.type])return;var e=c?d.touchid:d.id,f;d.type=="tap"?f={dt:d.dt}:d.type=="release"?f={dt:d.dt,v:d.v,multi:d.multi}:f={},f.id=e,f.pos=d.pos,f.t=d.t,a[d.type].push(f)}),a.ids=[];for(var e in this._touches){var f=this._touches[e],g=c?f.touchid:e;if(!f.followed)continue;a.ids.push(g);var h=f.pos,i=f.opos;a.ps[g]=h,a.deltas[g]=[h[0]-i[0],h[1]-i[1]],f.ot=f.t,f.opos=h}return a.ids.sort(),a},twotouchstate:function(a){if(a.ids.length!=2)return null;var b=a.ids[0],c=a.ids[1],d=a.ps[b][0],e=a.ps[b][1],f=a.ps[c][0],g=a.ps[c][1],h=f-d,i=g-e,j=Math.sqrt(h*h+i*i),k=j?Math.atan2(i,h):0,l=d-a.deltas[b][0],m=e-a.deltas[b][1],n=f-a.deltas[c][0],o=g-a.deltas[c][1],p=n-l,q=o-m,r=Math.sqrt(p*p+q*q),s=r?Math.atan2(q,p):0;return{center:[(d+f)/2,(e+g)/2],dcenter:[(d+f-l-n)/2,(e+g-m-g)/2],r:j,dr:j-r,rratio:r?j/r:1,theta:k,dtheta:k-s}},_captureevents:function(a,b){function c(a,b){return function(c){a[b](c)}}a=a||document,b=b||document,typeof a=="string"&&(a=document.getElementById(a)),typeof b=="string"&&(b=document.getElementById(b)),a.ontouchstart=c(this,"_ontouchstart"),a.ontouchmove=c(this,"_ontouchmove"),a.ontouchend=c(this,"_ontouchend"),this._element=a,this._backdrop=b},_addevent:function(a,b,c,d){this.capture[a]&&this._touches[b].followed&&(d.type=a,d.id=b,d.touchid=c,this._events.push(d))},_handlestart:function(a){if(!this.active)return;var b=a.identifier,c=this._ntouches++,d=this._eventpos(a),e=Date.now();this._touches[b]={id:b,touchid:c,t0:e,pos0:d,tlast:e,poslast:d,ot:e,opos:d,t:e,pos:d,moved:!1,followed:!0,held:!1,multi:1,multit0:e,vx:0,vy:0},this._settkeys(),this.touchmax&&this._tkeys.length>this.touchmax&&(this._touches[b].followed=!1),this._addevent("start",b,c,{pos:d,t:e}),!this.multi},_handlemove:function(a){if(!this.active)return;var b=a.identifier;this._touches[b]||this._handlestart(a);var c=this._touches[b],d=this._eventpos(a),e=Date.now(),f=e-c.t,g=d[0]-c.pos[0],h=d[1]-c.pos[1],i=d[0]-c.pos0[0],j=d[1]-c.pos0[1];c.t=e,c.pos=d,!c.moved&&Math.abs(i)+Math.abs(j)>this.dmove&&(c.moved=!0),f&&(c.vx=1e3*g/f+7,c.vy=1e3*h/f),this._checkhold()},_handleend:function(a){if(!this.active)return;var b=a.identifier;if(!this._touches[b])return;var c=this._touches[b],d=this._eventpos(a),e=Date.now(),f=e-c.t0;this._addevent("end",c.id,c.touchid,{t:e,dt:f,pos:d}),!c.moved&&!c.held?this._addevent("tap",c.id,c.touchid,{t:e,dt:f,pos:d}):this._addevent("release",c.id,c.touchid,{t:e,dt:f,pos0:c.pos0,pos:d,v:[c.vx,c.vy],multi:c.multi}),delete this._touches[b]},_settkeys:function(){this._tkeys=[];for(var a in this._touches)this._tkeys.push(a);this._tkeys.sort();var b=this._tkeys.length;for(var a in this._touches)this._touches[a].multi=Math.max(this._touches[a].multi,b)},_checkhold:function(){var a=Date.now();for(var b in this._touches){var c=this._touches[b];if(c.held||c.moved)continue;if(c.t0+this.thold>a)continue;c.held=!0,this._addevent("hold",c.id,c.touchid,{t:c.t0+this.thold,pos:c.pos})}},_ontouchstart:function(a){this.ps=this._getps(a.touches),this._mtouch=Math.max(this._mtouch,a.touches.length);for(var b=0;b<a.changedTouches.length;++b)this._handlestart(a.changedTouches[b]);this._checkhold(),a.preventDefault()},_ontouchmove:function(a){this.ps=this._getps(a.touches),this._mtouch=Math.max(this._mtouch,a.touches.length);for(var b=0;b<a.changedTouches.length;++b)this._handlemove(a.changedTouches[b]);this._checkhold(),a.preventDefault()},_ontouchend:function(a){this.ps=this._getps(a.touches),this._mtouch=Math.max(this._mtouch,a.touches.length),this._checkhold();for(var b=0;b<a.changedTouches.length;++b)this._handleend(a.changedTouches[b]);a.touches.length||(this._mtouch=0),this._settkeys(),a.preventDefault()},_eventpos:function(a,b){b=b||this._element;var c=b.getBoundingClientRect(),d=c.left+b.clientLeft-b.scrollLeft,e=c.top+b.clientTop-b.scrollTop,f=a.clientX-d,g=a.clientY-e;return this.roundpos?[Math.round(f),Math.round(g)]:[f,g]},_getps:function(a){var b=[];for(var c=0;c<a.length;++c)b.push(this._eventpos(a[c],this._element));return b}},"use strict";var UFX=UFX||{};UFX.pointer={init:function(a,b){UFX.mouse.capture.wheel=!0,UFX.mouse.init(a,b),UFX.touch.init(a,b)},state:function(){var a=UFX.mouse.state(),b=UFX.touch.state()}},"use strict";var UFX=UFX||{};UFX.resource={images:{},sounds:{},data:{},jsontypes:"js json".split(" "),imagetypes:"png gif jpg jpeg bmp tiff".split(" "),soundtypes:"wav mp3 ogg au".split(" "),rawtypes:"csv txt frag vert".split(" "),base:null,soundvolume:undefined,musicvolume:undefined,audiovolume:undefined,onload:function(){},onloading:function(a){},load:function(){var a=UFX.resource._extractlist(arguments);for(var b=0;b<a.length;++b){var c=a[b];this._load(c[0],c[1])}this._toload===0&&setTimeout(this.onload,0)},loadimage:function(){var a=this._extractlist(arguments);for(var b=0;b<a.length;++b){var c=a[b];this._loadimage(c[0],c[1])}},loadsound:function(){var a=this._extractlist(arguments);for(var b=0;b<a.length;++b){var c=a[b];this._loadsound(c[0],c[1])}},loadjson:function(){var a=this._extractlist(arguments);for(var b=0;b<a.length;++b){var c=a[b];this._loadjson(c[0],c[1])}},loadwebfonts:function(){WebFontConfig={google:{families:Array.prototype.slice.call(arguments)},fontactive:UFX.resource._onload};var a=document.createElement("script");a.src="https://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js",a.type="text/javascript",a.async="true",document.getElementsByTagName("head")[0].appendChild(a),this._toload+=arguments.length},setsoundvolume:function(a){this.soundsvolume=a},setmusicvolume:function(a){this.musicvolume=a,this.musicplaying&&(this.musicplaying.volume=this._getmusicvolume())},setaudiovolume:function(a){this.audiovolume=a,this.musicplaying&&(this.musicplaying.volume=this._getmusicvolume())},playsound:function(a){var b=this.sounds[a];if(!b){console.log("Missing sound: "+a);return}var c=this.soundvolume===undefined?this.audiovolume:this.soundvolume;c===undefined&&(c=1),b.volume=c,b.play()},musicplaying:null,_getmusicvolume:function(){return this.musicvolume!==undefined?this.musicvolume:this.audiovolume!==undefined?this.audiovolume:1},playmusic:function(a,b){this._completependingfades();if(!a)return this.stopmusic();var c=this.sounds[a];if(!c){console.log("Missing music: "+a);return}if(c===this.musicplaying)return;this.stopmusic(),c.volume=this._getmusicvolume(),c.currentTime=0,c.play(),c.loop=!b,this.musicplaying=c},stopmusic:function(){this._completependingfades(),this.musicplaying&&this.musicplaying.pause(),this.musicplaying=null},_fadeouttime0:1400,_fadeintime0:1400,_fadegap0:0,setfadetime:function(a,b,c){a!==undefined&&(this._fadeouttime0=a),b!==undefined&&(this._fadeintime0=b),c!==undefined&&(this._fadegap0=c)},setcrossfade:function(a){a===undefined&&(a=this._fadetime),this.setfadetime(a,a,-a)},_completependingfades:function(){this._fadetimeout&&(window.clearTimeout(this._fadetimeout),this._fadeinstart=-1,this._fadeoutstart=-1,this._fadecallback())},fadetomusic:function(a,b,c,d,e){this._completependingfades();if(this.musicplaying&&a&&this.sounds[a]===this.musicplaying)return;this._fadeouttime=b===undefined?this._fadeouttime0:b,this._fadeintime=c===undefined?this._fadeintime0:c,this._fadegap=d===undefined?this._fadegap0:d,this._fadeoutstart=Date.now(),this._fadeinstart=this._fadeoutstart+(this.musicplaying?this._fadeintime+this._fadegap:0),this._pendingmname=a,this._pendingnoloop=e,this._outgoingmusic=this.musicplaying,this.musicplaying=null,this._fadecallback()},crossfadetomusic:function(a,b,c){b===undefined&&(b=this._fadeouttime),this.fadetomusic(a,b,b,-b,c)},_fadecallback:function(){if(this._outgoingmusic){var a=Date.now()-this._fadeoutstart,b=this._fadeouttime>0?1-a/this._fadeouttime:a>0?0:1;b>0?this._outgoingmusic.volume=b*this._getmusicvolume():(this._outgoingmusic.pause(),this._outgoingmusic=null)}if(this._pendingmname){var c=Date.now()-this._fadeinstart,d=this._fadeintime>0?c/this._fadeintime:c>0?1:0;if(d>0){if(!this.musicplaying){var e=this.sounds[this._pendingmname];e?(e.currentTime=0,e.volume=0,e.play(),e.loop=!this._pendingnoloop,this.musicplaying=e):console.log("Missing music: "+mname)}d>=1?(this.musicplaying.volume=this._getmusicvolume(),this._pendingmname=null):this.musicplaying.volume=d*this._getmusicvolume()}}this._outgoingmusic||this._pendingmname?this._fadetimeout=window.setTimeout(this._fadecallback.bind(this),100):this._fadetimeout=null},Multisound:function(a,b){if(this instanceof UFX.resource.Multisound)this._init(a,b);else return new UFX.resource.SoundRandomizer(a,b)},SoundRandomizer:function(a,b){if(!(this instanceof UFX.resource.SoundRandomizer))return new UFX.resource.SoundRandomizer(a,b);this._sounds=[];for(var c=0;c<a.length;++c)this._sounds.push(typeof a[c]=="string"?UFX.resource.sounds[a[c]]:a[c]);this._nskip=Math.min(this._sounds.length-1,b||3),this._played=[],this.volume=1},mergesounds:function(){for(var a=0;a<arguments.length;++a){var b=[],c=arguments[a];for(var d in UFX.resource.sounds)d.indexOf(c)==0&&b.push(d);this.sounds[c]=this.SoundRandomizer(b)}},_seturl:function(a){if(!this.base)return a;var b=UFX.resource.base.length;return b?this.base+(this.base.charAt(b-1)=="/"?"":"/")+a:a},_load:function(a,b){var c=b.split(".").pop();return this.imagetypes.indexOf(c)>-1?this._loadimage(a,b):this.soundtypes.indexOf(c)>-1?this._loadsound(a,b):this.jsontypes.indexOf(c)>-1?this._loadjson(a,b):this.rawtypes.indexOf(c)>-1?this._loaddata(a,b):(console.log("Treating unknown extension "+c+" as raw data"),this._loaddata(a,b))},_loadimage:function(a,b){var c=new Image;c.onload=this._onload,c.src=this._seturl(b),c.iname=a,this.images[a]=c,++this._toload},_loadsound:function(a,b){var c=new Audio;c.addEventListener("canplaythrough",this._onload,!1),c.src=this._seturl(b),c.aname=a,this.sounds[a]=c,++this._toload},_loadjson:function(a,b){var c=new XMLHttpRequest;c.overrideMimeType("application/json"),c.open("GET",b,!0);var d=this;c.onload=function(){UFX.resource.data[a]=JSON.parse(c.responseText),UFX.resource._onload()},c.send(null),++this._toload},_loaddata:function(a,b){var c=new XMLHttpRequest;c.open("GET",b,!0);var d=this;c.onload=function(){UFX.resource.data[a]=c.responseText,UFX.resource._onload()},c.send(null),++this._toload},_extractlist:function(a){var b=[];for(var c=0;c<a.length;++c){var d=a[c];if(typeof d=="string")b.push([d,d]);else if(d instanceof Array)for(var e=0;e<d.length;++e)b.push([d[e],d[e]]);else for(var e in d)b.push([e,d[e]])}return b},_toload:0,_loaded:0,_onload:function(){++UFX.resource._loaded;var a=UFX.resource._loaded/UFX.resource._toload;UFX.resource.onloading(a),UFX.resource._loaded==UFX.resource._toload&&UFX.resource.onload()}};var WebFontConfig;UFX.resource.Multisound.prototype={_init:function(a,b){this.src=typeof a=="string"?a:a.src,this._sounds=[],this._n=b||10,this._k=0,this.volume=1;for(var c=0;c<this._n;++c){var d=new Audio;d.src=this.src,this._sounds.push(d)}},play:function(){var a=this._sounds[this._k++];this._k%=this._n,a.volume=this.volume,a.play()},pause:function(){for(var a=0;a<this._n;++a)this._sounds[a].pause()}},UFX.resource.SoundRandomizer.prototype={play:function(){do var a=UFX.random.rand(this._sounds.length);while(this._played.indexOf(a)>-1);var b=this._sounds[a];b.volume=this.volume,b.play();if(this._nskip){this._played.push(a);while(this._played.length>=this._nskip)this._played=this._played.slice(1)}},pause:function(){for(var a=0;a<this._sounds.length;++a)this._sounds[a].pause()}},"use strict";var UFX=
UFX||{};UFX.ticker={defaultopts:{sync:"auto",cthis:null,delay:0,minupf:1,maxupf:1,ups:null,minups:null,maxups:null,fps:30,cfac:null},init:function(a,b,c){this.setcallbacks(a,b),this.setoptions(c),this.resume()},setcallbacks:function(a,b){this._tcallback=a,this._dcallback=b},setoptions:function(a,b){if(!b)for(var c in this.defaultopts)this[c]=this.defaultopts[c];if(!a)return;for(var c in this.defaultopts)c in a&&(this[c]=a[c])},resume:function(){this.stop(),this.resetcounters(),this._running=!0,this._tick()},stop:function(){this._shandle&&window.cancelAnimationFrame(this._shandle),this._thandle&&clearTimeout(this._thandle),this._shandle=this._thandle=null,this._running=!1},resetcounters:function(){this._accumulator=0,this._dtu=0,this._dtg=0,this._dtf=0,this._lastthink=Date.now(),this._lastdraw=Date.now(),this.wfactor=1},getrates:function(){return[this.wfps.toPrecision(3)+"fps",this.wups.toPrecision(3)+"ups",this.wfactor.toPrecision(3)+"x"].join(" ")},_tick:function(){if(!this._running)return;var a=Date.now(),b=this._lasttick?(a-this._lasttick)*.001:0;this._lasttick=a,this._accumulator+=b;var c=this.fps,d=this.minupf,e=this.maxupf,f=this.minups||this.ups||c,g=this.maxups||this.ups||f,h=this.cfac||1/f,i,j,k,l;d==0?i=!0:i=this._accumulator>=d/g;if(!i)j=0,l=d/g;else if(d>=e)j=d,l=k=Math.min(this._accumulator,d/f);else{var m=Math.floor(this._accumulator*f);(m+1)/g<=this._accumulator&&(m+=1),j=Math.max(Math.min(m,e),d),k=Math.min(j/f,this._accumulator),l=Math.max(d,1)/g}if(j){this._accumulator-=k,a=Date.now(),this._dtu=(1-h*j)*this._dtu+h*.001*(a-this._lastthink),this._dtg=(1-h*j)*this._dtg+h*k,this._lastthink=a,k/=j;for(var n=0;n<j;++n)this._tcallback.call(this.cthis,k,n,j)}if(i&&this._dcallback){var o=this._accumulator*f;this._dcallback.call(this.cthis,o),a=Date.now(),this._dtf=(1-h)*this._dtf+h*.001*(a-this._lastdraw),this._lastdraw=a}this._accumulator=Math.max(Math.min(this._accumulator,l),0),this.wups=1/this._dtu,this.wfps=this._dcallback?1/this._dtf:this.wups,this.wfactor=this._dtg/this._dtu;if(!this._running)return;var p=this.sync=="auto"?window.requestAnimationFrame:this.sync;this._shandle=this._thandle=null;var q=function(a){return function(){a._tick()}}(this);if(p)this._shandle=window.requestAnimationFrame(q);else{var r=this._lasttick+1e3*(l-this._accumulator),s=Math.max(Math.ceil(r-Date.now()),this.delay);this._thandle=window.setTimeout(q,s)}}};