<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<title>GMTK 2025 game</title>
<script src="UFX.js"></script>
<script src="levels.js"></script>
<script src="world.js"></script>
<script src="progress.js"></script>
<script src="thing.js"></script>
<script src="view.js"></script>
<canvas id=canvas style="background: black"></canvas>
<script>
"use strict"
let DEBUG = window.location.href.includes("DEBUG")
let level0 = "start"
for (let piece of window.location.search.split("&")) {
	if (piece[0] == "?") piece = piece.slice(1)
	if (piece.slice(0, 6) == "level=") level0 = piece.slice(6)
}
let tau = 2 * Math.PI
let clamp = (x, a, b) => x < a ? a : x > b ? b : x
// Fixed mod function to behave like in Python.
let mod = (x, z) => (x % z + z) % z
// The value equal to x (mod z) that's closest to 0
let zmod = (x, z) => mod(x + z / 2, z) - z / 2
// The value equal to x (mod z) that's closest to x0
let cmod = (x, z, x0) => x0 + zmod(x - x0, z)
let approach = (x, target, dx) => x < target ? Math.min(x + dx, target) : Math.max(x - dx, target)
window.onerror = function (error, url, line) {
	document.body.innerHTML = "<p>Error in: "+url+"<p>line "+line+"<pre>"+error+"</pre>"
}
let canvas = document.getElementById("canvas")
canvas.width = 1600
canvas.height = 900
let context = canvas.getContext("2d")
UFX.maximize.fill(canvas, "aspect")
UFX.draw.setcontext(context)
UFX.audio.init()
UFX.audio.makegainnode({ name: "main", gain: 1, })
UFX.audio.makegainnode({ name: "sfx", output: "main" })
UFX.audio.makegainnode({ name: "music", output: "main", gain: 0.3 })
UFX.audio.loadbuffers({
//	select: "sound/select.ogg",
})
function playsound(sname) {
	UFX.audio.playbuffer(sname, { output: "sfx", gain: 1, })
}
UFX.key.init()
UFX.key.remaparrows(true)
UFX.key.watchlist = ["tab", "space", "enter", "left", "right", "up", "down", "F1", "1", "2", "3", "esc"]
UFX.resource.loadwebfonts("Viga", "Bokor", "Langar")
let toload = {
	test0: "img/test-0.jpg",
	test1: "img/test-1.png",
	tree: "img/tree.png",
	tower: "img/tower.png",
	castle: "img/castle.png",
	portalclosed: "img/portal-closed.png",
	portalopen: "img/portal-open.png",
	sign: "img/sign.png",
	star0: "img/star0.png",
	star1: "img/star1.png",
	star2: "img/star2.png",
	mushroom0: "img/mushroom0.png",
	mushroom1: "img/mushroom1.png",
	mushroom2: "img/mushroom2.png",
	hazard: "img/hazard.png",
}
for (let stage of ["start", "forest", "ruins", "under", "mountain", "water", "fire", "win"]) {
	toload[`symbol${stage}`] = `img/symbol-${stage}.png`
}
for (let model of [1, 2, 3]) {
	toload[`up${model}`] = `img/up${model}.png`
	toload[`down${model}`] = `img/down${model}.png`
	for (let frame of [0, 1, 2, 3]) {
		toload[`you${model}run${frame}`] = `img/run${model}-${frame}.png`
	}
	for (let frame of [0, 1]) {
		toload[`balloon${model}${frame}`] = `img/balloon-${model}-${frame}.png`
	}
}
UFX.resource.load(toload)
UFX.resource.onload = () => {
}
UFX.scene.push("load")
UFX.scene.init({ minups: 10, maxups: 120 })
UFX.resource.onloading = (f) => {
	UFX.scenes.load.f = f
}
UFX.scenes.load = {
	f: 0,
	tdot: 0,
	think: function (dt) {
		UFX.pointer.scale = UFX.maximize.scale.LD
		let pointer = UFX.pointer(canvas)
		let kstate = UFX.key.state()
		if (this.f == 1) {
			if (kstate.down.space || pointer.down) UFX.scene.swap("play")
		}
	},
	draw: function () {
		let t = 0.0003 * Date.now()
		let [r, g, b] = [0, 1/3, 2/3].map(phi => 128 + 120 * Math.sin(t + phi*tau))
		let color = `rgb(${Math.round(r)},${Math.round(g)},${Math.round(b)})`
		UFX.draw("fs", color, "f0")
		UFX.draw("[ z", canvas.width / 1600, canvas.height / 900)
		UFX.draw("[ t 500 140 font 100px~'Bokor' r -0.1",
			"tab center middle fs black ss gray lw 1 fst0 GMTK~Jam~2025~game",
			"font 50px~'Bokor'",
			"t 0 90 fst0 by~Christopher~Night",
			't 0 60 fst0 graphics~by~Sam~Thompson,~"Derpy_Feesh"',
			"]")
		let text = this.f == 1 ? "Tap~or~press~Space~to~begin" : `Loading...~${(100 * this.f).toFixed(0)}%`
		let grad = UFX.draw.lingrad(0, 30, 0, -30, 0, "#fff", 1, "#bbb")
		UFX.draw("[ t", 1000, 800,
			"font 80px~'Viga' fs", grad, "ss black shadow black 4 4 2",
			"tab center middle sft0", text, "]")
		UFX.draw("[ t 250 700 hflip r 0 z 2 2 drawimage", UFX.resource.images.up2, -171/2, -307/2, "]")
		UFX.draw("[ t 1250 200 hflip vflip r 0 z 2 2 drawimage", UFX.resource.images.up2, -171/2, -307/2, "]")
		UFX.draw("]")
	},
}

let speeds = [33, 40, 48, 58, 70, 83, 100, 120, 145, 175, 210, 250, 300]
function speedup(current) {
	if (current >= speeds[speeds.length - 1]) return speeds[speeds.length - 1]
	return speeds[speeds.indexOf(current) + 1]
}
function speeddown(current) {
	if (current <= speeds[0]) return speeds[0]
	return speeds[speeds.indexOf(current) - 1]
}

UFX.scenes.play = {
	start: function () {
		world.init(level0)
		view.init()
		this.speed = 100
		this.marquee = []
	},
	think: function (dt) {
		UFX.pointer.scale = UFX.maximize.scale.LD
		let pointer = UFX.pointer(canvas)
		let kstate = UFX.key.state()
		if (kstate.down.space || pointer.down) world.you.jump(world.balloons)
		if (kstate.down.space || pointer.down) world.you.interact(world.portals)
		if (kstate.down[1]) world.you.releaseballoon(1)
		if (kstate.down[2]) world.you.releaseballoon(2)
		if (kstate.down[3]) world.you.releaseballoon(3)
		if (kstate.down.esc) UFX.scene.push("pause")
		if (kstate.down.up) {
			this.speed = speedup(this.speed)
		}
		if (kstate.down.down) {
			this.speed = speeddown(this.speed)
		}
		dt *= this.speed / 100
		if (kstate.pressed.left) dt /= 3
		if (kstate.pressed.right) dt *= 3

		let jumpheld = kstate.pressed.space || pointer.isdown

		view.think(dt)
		world.think(dt, jumpheld)
		if (world.nextlevel !== null) UFX.scene.push("portal", world.nextlevel)
	},
	draw: function () {
		UFX.draw("fs", world.skycolor, "f0")
		UFX.draw("[ z", canvas.width / 1600, canvas.height / 900)
			world.draw()
			let info = `Speed:~${this.speed}%~~Coins:~${progress.score}`
			let texts = [
				"Space: jump",
				"Hold left/right: adjust speed",
				`Tap up/down: adjust speed`,
				`F11: fullscreen`,
				"Esc: pause/view progress",
			]
			UFX.draw("font 20px~'Viga' tab left bottom fs white ss black lw 2")
			texts.reverse().forEach((text, j) => {
				context.strokeText(text, 10, 890 - 20 * j)
				context.fillText(text, 10, 890 - 20 * j)
			})
			UFX.draw("[ tab right bottom ss white fs black font 30px~Viga sft", info, "1600 900 ]")
		for (let n of [1, 2, 3]) {
			UFX.draw("[ t", 1600 - 60 - 3 * 110 + 110 * n, 60,
				"b o 0 0 50 fs #885 f",
				"b o 0 0 48 fs #aa6 f",
				"b o 0 0 46 fs #885 f",
				"b o 0 0 44 fs #bbb f")
			if (world.you.cooldown[n]) {
				let f = world.you.cooldown[n]
				UFX.draw("( m 0 0 arc 0 0 44 0", tau * f, "l 0 0 ) fs gray f")
			}
			UFX.draw(
				"[ z 0.4 0.4 drawimage", UFX.resource.images[`balloon${n}0`], -90, -90, "]",
				"tab center middle font 30px~'Langar' fs #ccf ss black lw 3 sft0", ""+n,
				"]")
		}
		UFX.draw("]")
	},
}

UFX.scenes.pause = {
	start: function () {
		this.t = 0
	},
	think: function (dt) {
		this.t += dt
		let kstate = UFX.key.state()
		if (kstate.down.space || kstate.down.esc) {
			UFX.scene.pop()
		}
	},
	draw: function () {
		UFX.scenes.play.draw()
		let alpha = Math.min(2 * this.t, 0.7)
		UFX.draw("[ alpha", alpha, "fs gray f0 ]")

		let lines = ["Coins collected:"]
		for (let levelname in levels) {
			if (levelname in progress.levelstars) {
				lines.push(`${levels[levelname].title}: ${progress.got[levelname]}/${progress.levelstars[levelname]}`)
			}
		}
		lines.push(`Total: ${progress.score}`)
		UFX.draw("font 45px~'Bokor' tab left top fs white ss black lw 2")
		lines.forEach((text, j) => {
			context.strokeText(text, 50, 50 + 50 * j)
			context.fillText(text, 50, 50 + 50 * j)
		})

	},
}

UFX.scenes.portal = {
	start: function (to) {
		this.from = world.levelname
		this.to = to
		world.init(this.to, this.from)
		view.init()
	},
	think: function (dt) {
		UFX.pointer.scale = UFX.maximize.scale.LD
		let pointer = UFX.pointer(canvas)
		let kstate = UFX.key.state()
		UFX.scene.pop()
	},
}



</script>

